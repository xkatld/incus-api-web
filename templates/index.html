<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incus Web 管理器</title>

    <link rel="stylesheet" href="https://unpkg.com/antd@5.11.0/dist/reset.css">
    <link rel="stylesheet" href="https://unpkg.com/antd@5.11.0/dist/antd.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/antd@5.11.0/dist/antd.min.js"></script>


    <style>
        body { padding-top: 20px; background-color: #f0f2f5; }
        .container {
             max-width: 1200px;
             margin: 0 auto;
             padding: 0 15px;
        }
         .site-layout-content {
             background: #fff;
             padding: 24px;
             min-height: 280px;
             margin-top: 20px;
         }


        #execOutput, .info-pre {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 8px;
        }
        #execOutput.success { border-color: #b7eb8f; background-color: #f6ffed; color: #237804; }
        #execOutput.error { border-color: #ffccc7; background-color: #fff1f0; color: #cf1322; }
        #infoContent { background-color: transparent; border: none; padding: 0; }


        .d-flex-desktop { display: none !important; }
        .container-list-mobile { display: block; }
        .container-list-desktop { display: none; }

        @media (min-width: 768px) {
            .d-flex-desktop {
                display: flex !important;
                flex-direction: row;
                gap: 8px;
                align-items: center;
            }
             .container-list-mobile {
                display: none !important;
             }
             .container-list-desktop {
                 display: block !important;
             }
             .ant-table-thead > tr > th:nth-child(1) { width: 15%; }
             .ant-table-thead > tr > th:nth-child(2) { width: 10%; }
             .ant-table-thead > tr > th:nth-child(3) { width: 15%; }
             .ant-table-thead > tr > th:nth-child(4) { width: 20%; }
             .ant-table-thead > tr > th:nth-child(5) { width: 15%; }
             .ant-table-thead > tr > th:nth-child(6) { width: 25%; }
        }

         .ant-list-item {
             background-color: #fff;
             border: 1px solid #f0f0f0;
             margin-bottom: 8px;
             padding: 12px;
             border-radius: 2px;
         }
          .ant-list-item .ant-list-item-meta-title {
              word-break: break-word;
          }
          .ant-list-item .ant-list-item-meta-description small strong {
              font-weight: bold;
              margin-right: 5px;
              color: rgba(0, 0, 0, 0.85);
          }
          .ant-list-item-action {
              margin-left: 12px !important;
               flex-wrap: wrap;
               gap: 4px;
          }


         #loginContainer {
             max-width: 400px;
             margin: 50px auto;
             padding: 24px;
             border: none;
             border-radius: 2px;
             background-color: #fff;
             box-shadow: 0 1px 2px -2px rgba(0, 0, 0, 0.16), 0 3px 6px 0 rgba(0, 0, 0, 0.12), 0 5px 12px 4px rgba(0, 0, 0, 0.09);
         }
         #loginContainer h2 {
             text-align: center;
             margin-bottom: 24px;
             font-size: 24px;
             color: rgba(0, 0, 0, 0.85);
         }

         .ant-btn-info {
             color: #0dcaf0;
             border-color: #0dcaf0;
         }
         .ant-btn-info:hover { color: #0aa2c0; border-color: #0aa2c0; }


    </style>
</head>
<body>
    {% if session.logged_in %}
    <div class="container">
         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-top: 20px;">
             <h1 style="font-size: 30px; margin: 0;">Incus Web 管理器</h1>
             <button type="button" class="ant-btn ant-btn-danger ant-btn-sm" onclick="location.href='{{ url_for('logout') }}'">
                  <span>退出登录</span>
             </button>
        </div>

        {% if incus_error[0] %}
        <div class="ant-alert ant-alert-error ant-alert-with-description" role="alert" style="margin-bottom: 24px;">
            <div class="ant-alert-icon"><span role="img" aria-label="close-circle" class="anticon anticon-close-circle"><svg viewbox="64 64 896 896" focusable="false" data-icon="close-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm165.4 336.6V280.8c0-6.7-7.7-10.4-12.9-6.3L512 423.6l-152.2-149.1c-5.2-4.1-12.9-0.4-12.9 6.3v121.8c0 4.6 2.1 8.9 5.6 11.6L512 603l148.2-146.4c3.5-2.7 5.6-7.1 5.6-11.7z"></path></svg></span></div>
            <div class="ant-alert-content">
                <div class="ant-alert-message"><strong>错误:</strong> 无法连接到 Incus 或执行命令失败。</div>
                <div class="ant-alert-description">显示的数据可能来自数据库缓存。<br>详细信息: {{ incus_error[1] }}</div>
            </div>
        </div>
        {% endif %}

        <div class="ant-card ant-card-bordered" style="margin-bottom: 24px;">
            <div class="ant-card-head">
                <div class="ant-card-head-wrapper"><div class="ant-card-head-title">创建新容器</div></div>
            </div>
            <div class="ant-card-body">
                <form id="createContainerForm" class="ant-form ant-form-vertical">
                    <div class="ant-row ant-row-no-wrap" style="margin-left: -8px; margin-right: -8px;">
                        <div class="ant-col ant-col-md-8 ant-col-xs-24" style="padding-left: 8px; padding-right: 8px;">
                            <div class="ant-form-item ant-form-item-vertical">
                                <div class="ant-form-item-label"><label for="containerName" class="" title="">容器名称</label></div>
                                <div class="ant-form-item-control">
                                    <div class="ant-form-item-control-input">
                                        <div class="ant-form-item-control-input-content">
                                             <input type="text" class="ant-input" id="containerName" name="name" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ant-col ant-col-md-10 ant-col-xs-24" style="padding-left: 8px; padding-right: 8px;">
                            <div class="ant-form-item ant-form-item-vertical {% if image_error[0] %}ant-form-item-has-error{% endif %}">
                                <div class="ant-form-item-label"><label for="containerImage" class="" title="">选择镜像</label></div>
                                <div class="ant-form-item-control">
                                    <div class="ant-form-item-control-input">
                                        <div class="ant-form-item-control-input-content">
                                            <select class="ant-select ant-select-single ant-select-allow-clear ant-select-show-arrow ant-select-bordered" id="containerImage" name="image" required>
                                                <option value="" selected disabled>请选择一个镜像</option>
                                                {% for image in images %}
                                                <option value="{{ image.name }}">{{ image.description }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                     {% if image_error[0] %}
                                     <div class="ant-form-item-explain ant-form-item-explain-error">
                                         <div role="alert">{{ image_error[1] }}</div>
                                     </div>
                                     {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="ant-col ant-col-md-6 ant-col-xs-24" style="padding-left: 8px; padding-right: 8px; display: flex; align-items: flex-end;">
                            <div class="ant-form-item" style="width: 100%; margin-bottom: 0;">
                                <div class="ant-form-item-control">
                                     <button type="submit" class="ant-btn ant-btn-primary" id="createButton">
                                         <span>创建容器</span>
                                     </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <h2 style="font-size: 24px; margin-bottom: 16px;">容器列表</h2>

        <div class="container-list-desktop">
            <table class="ant-table">
                 <thead class="ant-table-thead">
                     <tr>
                        <th class="ant-table-cell">名称</th>
                        <th class="ant-table-cell">状态</th>
                        <th class="ant-table-cell">IP 地址</th>
                        <th class="ant-table-cell">镜像来源</th>
                        <th class="ant-table-cell">创建时间</th>
                        <th class="ant-table-cell">操作</th>
                    </tr>
                 </thead>
                 <tbody class="ant-table-tbody" id="containerListDesktop">
                    {% for c in containers %}
                     <tr class="ant-table-row ant-table-row-level-0">
                        <td class="ant-table-cell">{{ c.name }}</td>
                        <td class="ant-table-cell">
                            <span class="ant-tag ant-tag-{% if c.status == 'Running' %}success{% elif c.status == 'Stopped' %}error{% else %}default{% endif %}">{{ c.status }}</span>
                         </td>
                        <td class="ant-table-cell">{{ c.ip if c.ip and c.ip != 'N/A' else '-' }}</td>
                        <td class="ant-table-cell">{{ c.image_source if c.image_source else 'N/A' }}</td>
                        <td class="ant-table-cell">{{ c.created_at.split('T')[0] if c.created_at else 'N/A' }}</td>
                        <td class="ant-table-cell container-actions">
                            <div class="d-flex-desktop">
                                <button type="button" class="ant-btn ant-btn-sm ant-btn-info" onclick="showInfo('{{ c.name }}', this)">信息</button>
                                {% if c.status == 'Running' %}
                                <button type="button" class="ant-btn ant-btn-sm ant-btn-warning" onclick="performAction('{{ c.name }}', 'stop', this)">停止</button>
                                <button type="button" class="ant-btn ant-btn-sm ant-btn-default" onclick="performAction('{{ c.name }}', 'restart', this)">重启</button>
                                <button type="button" class="ant-btn ant-btn-sm ant-btn-primary" onclick="openExecModal('{{ c.name }}')">执行命令</button>
                                <button type="button" class="ant-btn ant-btn-sm ant-btn-dark" onclick="openNatModal('{{ c.name }}')">添加NAT</button>
                                {% elif c.status == 'Stopped' %}
                                <button type="button" class="ant-btn ant-btn-sm ant-btn-success" onclick="performAction('{{ c.name }}', 'start', this)">启动</button>
                                {% endif %}
                                <button type="button" class="ant-btn ant-btn-sm ant-btn-danger" onclick="performAction('{{ c.name }}', 'delete', this)">删除</button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                     <tr class="ant-table-placeholder">
                         <td colspan="6" class="ant-table-cell" style="text-align: center;">没有找到容器或无法连接到 Incus。</td>
                     </tr>
                    {% endfor %}
                 </tbody>
            </table>
        </div>

        <div class="container-list-mobile">
            {% for c in containers %}
            <div class="ant-card ant-card-bordered" style="margin-bottom: 16px;">
                <div class="ant-card-body">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h5 style="font-size: 16px; margin: 0; word-break: break-word;">{{ c.name }}</h5>
                        <span class="ant-tag ant-tag-{% if c.status == 'Running' %}success{% elif c.status == 'Stopped' %}error{% else %}default{% endif %}">{{ c.status }}</span>
                    </div>

                    <p style="margin-bottom: 4px;"><small style="font-weight: bold; margin-right: 5px; color: rgba(0, 0, 0, 0.65);">IP 地址:</small> {{ c.ip if c.ip and c.ip != 'N/A' else '-' }}</p>
                    <p style="margin-bottom: 4px;"><small style="font-weight: bold; margin-right: 5px; color: rgba(0, 0, 0, 0.65);">镜像:</small> {{ c.image_source if c.image_source else 'N/A' }}</p>
                    <p style="margin-bottom: 16px;"><small style="font-weight: bold; margin-right: 5px; color: rgba(0, 0, 0, 0.65);">创建时间:</small> {{ c.created_at.split('T')[0] if c.created_at else 'N/A' }}</p>

                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button type="button" class="ant-btn ant-btn-sm ant-btn-info" onclick="showInfo('{{ c.name }}', this)">信息</button>
                        {% if c.status == 'Running' %}
                        <button type="button" class="ant-btn ant-btn-sm ant-btn-warning" onclick="performAction('{{ c.name }}', 'stop', this)">停止</button>
                        <button type="button" class="ant-btn ant-btn-sm ant-btn-default" onclick="performAction('{{ c.name }}', 'restart', this)">重启</button>
                        <button type="button" class="ant-btn ant-btn-sm ant-btn-primary" onclick="openExecModal('{{ c.name }}')">执行命令</button>
                         <button type="button" class="ant-btn ant-btn-sm ant-btn-dark" onclick="openNatModal('{{ c.name }}')">添加NAT</button>
                        {% elif c.status == 'Stopped' %}
                        <button type="button" class="ant-btn ant-btn-sm ant-btn-success" onclick="performAction('{{ c.name }}', 'start', this)">启动</button>
                        {% endif %}
                        <button type="button" class="ant-btn ant-btn-sm ant-btn-danger" onclick="performAction('{{ c.name }}', 'delete', this)">删除</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="ant-alert ant-alert-info ant-alert-no-icon" role="alert" style="text-align: center;">没有找到容器或无法连接到 Incus。</div>
            {% endfor %}
        </div>

         <button type="button" class="ant-btn ant-btn-default" style="margin-top: 16px;" onclick="location.reload()">刷新列表</button>
    </div>
    {% else %}
    <div class="container">
        <div id="loginContainer">
             <h2 style="text-align: center; margin-bottom: 24px;">管理员登录</h2>
             <form method="POST" action="{{ url_for('login') }}" class="ant-form ant-form-vertical">
                 <input type="hidden" name="next" value="{{ request.args.get('next', '') }}">
                 <div class="ant-form-item ant-form-item-vertical" style="margin-bottom: 16px;">
                    <div class="ant-form-item-label"><label for="username" class="" title="">用户名</label></div>
                    <div class="ant-form-item-control">
                        <div class="ant-form-item-control-input">
                            <div class="ant-form-item-control-input-content">
                                <input type="text" class="ant-input" id="username" name="username" required autofocus>
                            </div>
                        </div>
                    </div>
                 </div>
                  <div class="ant-form-item ant-form-item-vertical" style="margin-bottom: 24px;">
                    <div class="ant-form-item-label"><label for="password" class="" title="">密码</label></div>
                    <div class="ant-form-item-control">
                         <div class="ant-form-item-control-input">
                            <div class="ant-form-item-control-input-content">
                                <input type="password" class="ant-input" id="password" name="password" required>
                            </div>
                        </div>
                    </div>
                 </div>
                 {% if login_error %}
                 <div class="ant-alert ant-alert-error ant-alert-no-icon" role="alert" style="margin-bottom: 24px;">{{ login_error }}</div>
                 {% endif %}
                 <button type="submit" class="ant-btn ant-btn-primary" style="width: 100%;">登录</button>
             </form>
        </div>
    </div>
    {% endif %}


    <script>
        const AntdModal = window.antd ? window.antd.Modal : null;
        const AntdMessage = window.antd ? window.antd.message : null;
        const AntdNotification = window.antd ? window.antd.notification : null;


        function showToast(message, type = 'info') {
             if (!AntdMessage) {
                 console.error("Ant Design message component not available.");
                 alert(message);
                 return;
             }
             switch(type) {
                 case 'success': AntdMessage.success(message); break;
                 case 'error': AntdMessage.error(message); break;
                 case 'warning': AntdMessage.warning(message); break;
                 case 'info': AntdMessage.info(message); break;
                 default: AntdMessage.info(message);
             }
         }


        function setButtonProcessing(button, isProcessing) {
            const $button = $(button);
            if (!$button.length) {
                 console.warn("Button element not found for processing state update.");
                 return;
            }

            if (isProcessing) {
                $button.addClass('ant-btn-loading').prop('disabled', true);
                 const originalText = $button.find('span').text();
                 if (originalText && !$button.data('original-text')) {
                      $button.data('original-text', originalText);
                 }
                 $button.find('span:not(.ant-btn-loading-icon)').hide();
            } else {
                $button.removeClass('ant-btn-loading').prop('disabled', false);
                 if ($button.data('original-text')) {
                     $button.find('span:not(.ant-btn-loading-icon)').text($button.data('original-text')).show();
                     $button.removeData('original-text');
                 } else {
                       $button.find('span').show();
                 }
            }
        }

        let currentConfirmAction = null;
        let currentConfirmTarget = null;
        let currentConfirmButtonElement = null;
        let confirmModalInstance = null;


        function showConfirmationModal(actionType, nameOrId, buttonElement) {
            if (!AntdModal) {
                 showToast("确认对话框组件不可用。", 'danger');
                 return;
            }

            currentConfirmAction = actionType;
            currentConfirmTarget = nameOrId;
            currentConfirmButtonElement = buttonElement;

            let title = '';
            let content = '';
            let okText = '确认';
            let okType = 'primary';

            if (actionType === 'restart_container') {
                title = '确认重启';
                content = `确定要重启容器 <strong>${nameOrId}</strong> 吗？`;
                okText = '重启';
                okType = 'default';
            } else if (actionType === 'delete_container') {
                title = '确认删除容器';
                content = `<strong>警告：</strong> 这将永久删除容器 <strong>${nameOrId}</strong> 及其所有数据！<br>同时将强制删除所有通过本应用添加的关联 NAT 规则。<br>确定删除吗？`;
                okText = '删除容器';
                okType = 'danger';
            } else if (actionType === 'delete_nat_rule') {
                title = '确认删除 NAT 规则';
                content = `确定要删除 ID 为 <strong>${nameOrId}</strong> 的 NAT 规则吗？此操作将尝试移除对应的 iptables 规则记录 (仅针对通过本应用添加的规则)。`;
                okText = '删除规则';
                okType = 'danger';
            }

             confirmModalInstance = AntdModal.confirm({
                 title: title,
                 content: content,
                 icon: AntdModal.warning ? window.antd.ExclamationCircleOutlined : null,
                 okText: okText,
                 okType: okType,
                 cancelText: '取消',
                 onOk: handleConfirmAction,
                 onCancel: handleConfirmCancel,
                 centered: true,
                 maskClosable: true,
             });
        }

        const handleConfirmAction = () => {
            const actionType = currentConfirmAction;
            const target = currentConfirmTarget;
            const buttonElement = currentConfirmButtonElement;

            if (!actionType || !buttonElement) {
                showToast("确认信息丢失，无法执行操作。", 'danger');
                 if (confirmModalInstance) {
                     confirmModalInstance.destroy();
                     confirmModalInstance = null;
                 }
                return Promise.reject();
            }

            if (actionType !== 'delete_nat_rule') {
                 setButtonProcessing(buttonElement, true);
            }

            let url = '';
            let method = '';
            let postData = null;

            if (actionType === 'delete_nat_rule') {
                url = `/container/nat_rule/${target}`;
                method = 'DELETE';
            } else if (actionType === 'restart_container' || actionType === 'delete_container') {
                url = `/container/${target}/action`;
                method = 'POST';
                postData = { action: actionType.replace('_container', '') };
            } else {
                 console.error("Unknown confirm action type:", actionType);
                 showToast("未知确认操作类型。", 'danger');
                 setButtonProcessing(buttonElement, false);
                  if (confirmModalInstance) {
                     confirmModalInstance.destroy();
                     confirmModalInstance = null;
                 }
                 return Promise.reject();
            }

             return $.ajax({
                url: url,
                type: method,
                data: postData,
                headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                success: function(data) {
                    showToast(data.message, data.status);
                    if (data.status === 'success' || data.status === 'warning') {
                        if (actionType === 'delete_nat_rule') {
                             if (infoModalInstance && selectedContainerName) {
                                loadNatRules(selectedContainerName);
                             }
                        } else {
                            setTimeout(() => location.reload(), 1000);
                        }
                    }
                    return Promise.resolve();
                },
                error: function(jqXHR) {
                     if (jqXHR.status === 401) {
                        showToast("操作需要认证，请重新登录。", 'danger');
                         setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                    } else {
                        const message = jqXHR.responseJSON ? (jqXHR.responseJSON.message || jqXHR.responseText || "未知错误") : `执行操作请求失败。`;
                        showToast("操作失败: " + message, 'danger');
                    }
                    if (actionType !== 'delete_nat_rule') {
                         setButtonProcessing(buttonElement, false);
                    }
                    return Promise.resolve();
                }
            });
        };

        const handleConfirmCancel = () => {
             console.log('Confirm cancelled');
        };


        $('#createContainerForm').submit(function(event) {
            event.preventDefault();
            const form = $(this);
            const submitButton = $('#createButton', form);

            const containerName = $('#containerName').val().trim();
            const containerImage = $('#containerImage').val();
             if (!containerName || !containerImage) {
                 showToast("请填写容器名称并选择镜像。", 'warning');
                 return;
             }

            setButtonProcessing(submitButton, true);

            var formData = form.serialize();
            $.ajax({
                url: "{{ url_for('create_container') }}",
                type: "POST",
                data: formData,
                headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                success: function(data) {
                    showToast(data.message, data.status);
                    if (data.status === 'success') {
                        form[0].reset();
                         setTimeout(() => location.reload(), 1000);
                    } else {
                         setButtonProcessing(submitButton, false);
                    }
                },
                error: function(jqXHR) {
                     if (jqXHR.status === 401) {
                        showToast("操作需要认证，请重新登录。", 'danger');
                        setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                     } else {
                        const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "创建容器请求失败。";
                        showToast("错误: " + message, 'danger');
                        setButtonProcessing(submitButton, false);
                     }
                }
            });
        });

        function performAction(containerName, action, buttonElement) {
            if (action === 'restart' || action === 'delete') {
                showConfirmationModal(`${action}_container`, containerName, buttonElement);
                return;
            }

            setButtonProcessing(buttonElement, true);

            $.ajax({
                url: `/container/${containerName}/action`,
                type: "POST",
                data: { action: action },
                headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                success: function(data) {
                    showToast(data.message, data.status);
                    if (data.status === 'success') {
                         setTimeout(() => location.reload(), 1000);
                    } else {
                         setButtonProcessing(buttonElement, false);
                    }
                },
                error: function(jqXHR) {
                     if (jqXHR.status === 401) {
                        showToast("操作需要认证，请重新登录。", 'danger');
                        setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                     } else {
                        const message = jqXHR.responseJSON ? (jqXHR.responseJSON.message || "未知错误") : `执行 ${action} 操作请求失败。`;
                        showToast("操作失败: " + message, 'danger');
                        setButtonProcessing(buttonElement, false);
                     }
                }
            });
        }

        let infoModalInstance = null;
        let selectedContainerName = null;

        function showInfo(containerName, buttonElement) {
            if (!AntdModal) {
                 showToast("信息对话框组件不可用。", 'danger');
                 return;
            }

            selectedContainerName = containerName;

             let initialContent = `
                 <p>正在加载基础信息...</p>
                 <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                     <h6 style="margin-bottom: 10px;">NAT 规则 (本应用添加)</h6>
                      <ul id="natRulesContent"><li>正在加载 NAT 规则...</li></ul>
                      <div id="natRulesError" class="ant-alert ant-alert-warning ant-alert-no-icon d-none" role="alert" style="margin-top: 8px;"></div>
                 </div>
                 <div id="infoError" class="ant-alert ant-alert-danger ant-alert-no-icon d-none" role="alert" style="margin-top: 8px;"></div>
            `;

             infoModalInstance = AntdModal.modal({
                 title: `容器信息: ${containerName}`,
                 content: initialContent,
                 footer: null,
                 width: 800,
                 centered: true,
                 onCancel: () => { if(infoModalInstance) infoModalInstance.destroy(); infoModalInstance = null; selectedContainerName = null; },
             });

            setButtonProcessing(buttonElement, true);

            $.ajax({
                url: `/container/${containerName}/info`,
                type: "GET",
                headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                success: function(data) {
                     let infoHtml = '';
                     let currentInfoError = null;

                     if (data.status === 'NotFound') {
                         infoHtml = `<strong>错误:</strong> ${data.message}`;
                         currentInfoError = data.message;
                         showToast("加载容器信息失败。", 'danger');
                     } else {
                         infoHtml = `
                             <p><strong>名称:</strong> ${data.name}</p>
                             <p><strong>状态:</strong> <span class="ant-tag ant-tag-${data.status === 'Running' ? 'success' : data.status === 'Stopped' ? 'error' : 'default'}">${data.status}</span> (代码: ${data.status_code})</p>
                             <p><strong>IP 地址:</strong> ${data.ip && data.ip !== 'N/A' ? data.ip : '-'}</p>
                             <p><strong>镜像来源/描述:</strong> ${data.description && data.description !== 'N/A' ? data.description : data.image_source && data.image_source !== 'N/A' ? data.image_source : 'N/A'}</p>
                             <p><strong>创建时间:</strong> ${data.created_at ? data.created_at.split('T')[0] : 'N/A'}</p>
                             <p><strong>架构:</strong> ${data.architecture && data.architecture !== 'N/A' ? data.architecture : 'N/A'}</p>
                             <p><strong>类型:</strong> ${data.type}</p>
                              <p><strong>临时容器:</strong> ${data.ephemeral ? '是' : '否'}</p>
                             <p><strong>配置文件:</strong> ${data.profiles.join(', ') || '无'}</p>
                              ${data.message ? `<p><small>${data.message}</small></p>` : ''}
                         `;
                         if (!data.live_data_available) {
                              showToast(data.message || "显示数据可能非最新。", 'warning');
                         }
                     }

                     const modalBody = infoModalInstance.$().find('.ant-modal-body');
                     const basicInfoArea = $('<div>').html(infoHtml);

                      const natRulesSection = $(`
                         <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                             <h6 style="margin-bottom: 10px;">NAT 规则 (本应用添加)</h6>
                             <ul id="natRulesContent"><li>正在加载 NAT 规则...</li></ul>
                              <div id="natRulesError" class="ant-alert ant-alert-warning ant-alert-no-icon d-none" role="alert" style="margin-top: 8px;"></div>
                         </div>
                     `);

                      const infoErrorAlert = $(`<div id="infoError" class="ant-alert ant-alert-danger ant-alert-no-icon ${currentInfoError ? '' : 'd-none'}" role="alert" style="margin-top: 8px;">${currentInfoError || ''}</div>`);

                     modalBody.empty().append(basicInfoArea).append(natRulesSection).append(infoErrorAlert);

                     if (data.status !== 'NotFound') {
                        loadNatRules(containerName);
                     } else {
                         natRulesSection.hide();
                         modalBody.find('#natRulesContent').html('<li>无法加载 NAT 规则。</li>');
                     }

                },
                error: function(jqXHR) {
                     if (jqXHR.status === 401) {
                        showToast("加载容器信息需要认证，请重新登录。", 'danger');
                        if (infoModalInstance) { infoModalInstance.destroy(); infoModalInstance = null; selectedContainerName = null;}
                        setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                     } else {
                        const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "请求失败，无法加载详细信息。";
                        const modalBody = infoModalInstance.$().find('.ant-modal-body');
                         modalBody.empty().html(`<strong>错误:</strong> ${message}<div id="infoError" class="ant-alert ant-alert-danger ant-alert-no-icon" role="alert" style="margin-top: 8px;">${message}</div>`);
                         modalBody.find('#natRulesList').hide();
                        showToast("加载容器信息失败。", 'danger');
                     }
                },
                complete: function() {
                    setButtonProcessing(buttonElement, false);
                }
            });
        }

        function loadNatRules(containerName) {
            const modalBody = infoModalInstance.$().find('.ant-modal-body');
            const natRulesContent = modalBody.find('#natRulesContent');
            const natRulesError = modalBody.find('#natRulesError');

            natRulesContent.html('<li>正在加载 NAT 规则...</li>');
            natRulesError.addClass('d-none').text('');

             $.ajax({
                url: `/container/${containerName}/nat_rules`,
                type: "GET",
                headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                success: function(data) {
                    natRulesContent.empty();

                    if (data.status === 'success' && data.rules && data.rules.length > 0) {
                        data.rules.forEach(rule => {
                            const ruleHtml = `
                                <li data-rule-id="${rule.id}" style="background-color: #f9f9f9; border: 1px solid #eee; margin-bottom: 8px; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                                    <span class="rule-details" style="flex-grow: 1; margin-right: 10px; word-break: break-word;">
                                        <strong>ID ${rule.id}:</strong> 主机 ${rule.host_port}/${rule.protocol} → 容器 ${rule.ip_at_creation}:${rule.container_port}
                                        <br><small style="color: rgba(0, 0, 0, 0.65);">记录创建时间: ${rule.created_at ? new Date(rule.created_at).toLocaleString() : 'N/A'}</small>
                                    </span>
                                    <span class="rule-actions" style="flex-shrink: 0; margin-left: auto;">
                                         <button type="button" class="ant-btn ant-btn-sm ant-btn-danger" onclick="deleteNatRule(${rule.id}, this)">删除</button>
                                    </span>
                                </li>
                            `;
                            natRulesContent.append(ruleHtml);
                        });
                    } else if (data.status === 'success' && data.rules && data.rules.length === 0) {
                        natRulesContent.html('<li>没有通过本应用添加的 NAT 规则记录。</li>');
                    } else {
                         natRulesContent.html('<li>加载 NAT 规则失败。</li>');
                         natRulesError.removeClass('d-none').text(data.message || '未知错误获取规则列表。');
                         showToast(data.message || "加载 NAT 规则失败。", 'danger');
                    }
                },
                error: function(jqXHR) {
                     if (jqXHR.status === 401) {
                        showToast("加载 NAT 规则需要认证，请重新登录。", 'danger');
                         if (infoModalInstance) { infoModalInstance.destroy(); infoModalInstance = null; selectedContainerName = null;}
                         setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                     } else {
                         const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "请求失败，无法加载 NAT 规则。";
                         natRulesContent.html('<li>加载 NAT 规则失败。</li>');
                         natRulesError.removeClass('d-none').text(message);
                         showToast(message, 'danger');
                     }
                }
            });
        }


        function deleteNatRule(ruleId, buttonElement) {
            showConfirmationModal('delete_nat_rule', ruleId, buttonElement);
        }


        let execModalInstance = null;

        function openExecModal(containerName) {
             if (!AntdModal) {
                 showToast("执行命令对话框组件不可用。", 'danger');
                 return;
            }

            selectedContainerName = containerName;

             const execContent = `
                  <form id="execCommandForm" class="ant-form ant-form-vertical">
                      <input type="hidden" id="execContainerName" name="container_name" value="${containerName}">
                      <div class="ant-form-item ant-form-item-vertical" style="margin-bottom: 16px;">
                          <div class="ant-form-item-label"><label for="commandInput" class="" title="">命令 (例如: ls -l / 或 apt update)</label></div>
                          <div class="ant-form-item-control">
                              <div class="ant-form-item-control-input">
                                  <div class="ant-form-item-control-input-content">
                                       <input type="text" class="ant-input" id="commandInput" name="command" required>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="ant-form-item">
                           <div class="ant-form-item-control">
                                <button type="submit" class="ant-btn ant-btn-primary" id="execButton">执行</button>
                           </div>
                      </div>
                  </form>
                  <h6 style="font-size: 14px; margin-top: 20px; margin-bottom: 8px;">输出:</h6>
                  <pre id="execOutput" class="mt-2"></pre>
             `;

             execModalInstance = AntdModal.modal({
                 title: `在容器 ${containerName} 内执行命令`,
                 content: execContent,
                 footer: null,
                 width: 700,
                 centered: true,
                 onCancel: () => { if(execModalInstance) execModalInstance.destroy(); execModalInstance = null; selectedContainerName = null;},
             });

             $(document).off('submit', '#execCommandForm').on('submit', '#execCommandForm', function(event) {
                  event.preventDefault();
                  const form = $(this);
                  const submitButton = $('#execButton', form);
                  const outputArea = $('#execOutput');

                  var containerName = $('#execContainerName').val();
                  var command = $('#commandInput').val();

                  if (!command.trim()) {
                      showToast("请输入要执行的命令。", 'warning');
                      return;
                  }

                  outputArea.text('正在执行...');
                  outputArea.removeClass('success error').css({
                     'border-color': '#ccc', 'background-color': '#f5f5f5', 'color': 'rgba(0, 0, 0, 0.85)'
                  });


                  setButtonProcessing(submitButton, true);

                  $.ajax({
                      url: `/container/${containerName}/exec`,
                      type: "POST",
                      data: { command: command },
                      headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                      success: function(data) {
                          if (data.status === 'success') {
                              outputArea.text(data.output);
                              outputArea.addClass('success').css({
                                 'border-color': '#b7eb8f', 'background-color': '#f6ffed', 'color': '#237804'
                              });
                              showToast("命令执行成功。", 'success');
                          } else {
                              outputArea.text('命令执行失败:\n' + (data.output || data.message || '无详细输出'));
                              outputArea.addClass('error').css({
                                  'border-color': '#ffccc7', 'background-color': '#fff1f0', 'color': '#cf1322'
                              });
                              showToast(data.message || "命令执行失败。", 'danger');
                          }
                      },
                      error: function(jqXHR) {
                           if (jqXHR.status === 401) {
                              showToast("操作需要认证，请重新登录。", 'danger');
                              if (execModalInstance) { execModalInstance.destroy(); execModalInstance = null; selectedContainerName = null;}
                              setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                           } else {
                              const message = jqXHR.responseJSON ? (jqXHR.responseJSON.output || jqXHR.responseJSON.message || '未知错误') : "执行命令请求失败。";
                              outputArea.text("请求失败:\n" + message);
                               outputArea.addClass('error').css({
                                  'border-color': '#ffccc7', 'background-color': '#fff1f0', 'color': '#cf1322'
                              });
                              showToast("请求失败。", 'danger');
                           }
                      },
                      complete: function() {
                          setButtonProcessing(submitButton, false);
                      }
                  });
             });
        }

        let natModalInstance = null;
        let currentNatContainerIP = null;


        function openNatModal(containerName) {
             if (!AntdModal) {
                 showToast("添加 NAT 规则对话框组件不可用。", 'danger');
                 return;
            }

            selectedContainerName = containerName;
            currentNatContainerIP = null;

             const natContent = `
                 <div class="ant-alert ant-alert-warning ant-alert-no-icon" role="alert" style="margin-bottom: 20px;">
                     <div class="ant-alert-message">注意</div>
                     <div class="ant-alert-description">
                         这将在主机上添加一个临时的 iptables NAT 规则。规则在主机重启后会丢失，且需要此Web应用以足够权限(如 root 或 sudo)运行。成功添加规则时，iptables命令通常没有输出内容。
                     </div>
                 </div>
                 <form id="addNatForm" class="ant-form ant-form-vertical">
                     <input type="hidden" id="natContainerName" name="container_name" value="${containerName}">
                      <div class="ant-form-item ant-form-item-vertical" style="margin-bottom: 16px;">
                         <div class="ant-form-item-label"><label for="natContainerIP" class="" title="">容器 IP 地址 (添加规则时获取)</label></div>
                         <div class="ant-form-item-control">
                              <div class="ant-form-item-control-input">
                                  <div class="ant-form-item-control-input-content">
                                     <input type="text" class="ant-input" id="natContainerIP" value="正在获取 IP..." readonly>
                                  </div>
                              </div>
                         </div>
                     </div>
                     <div class="ant-form-item ant-form-item-vertical" style="margin-bottom: 16px;">
                         <div class="ant-form-item-label"><label for="hostPort" class="" title="">主机端口</label></div>
                         <div class="ant-form-item-control">
                              <div class="ant-form-item-control-input">
                                  <div class="ant-form-item-control-input-content">
                                     <input type="number" class="ant-input" id="hostPort" name="host_port" required min="1" max="65535">
                                  </div>
                              </div>
                         </div>
                     </div>
                      <div class="ant-form-item ant-form-item-vertical" style="margin-bottom: 16px;">
                         <div class="ant-form-item-label"><label for="containerPort" class="" title="">容器端口</label></div>
                         <div class="ant-form-item-control">
                              <div class="ant-form-item-control-input">
                                  <div class="ant-form-item-control-input-content">
                                     <input type="number" class="ant-input" id="containerPort" name="container_port" required min="1" max="65535">
                                  </div>
                              </div>
                         </div>
                     </div>
                     <div class="ant-form-item ant-form-item-vertical" style="margin-bottom: 24px;">
                         <div class="ant-form-item-label"><label for="protocol" class="" title="">协议</label></div>
                         <div class="ant-form-item-control">
                              <div class="ant-form-item-control-input">
                                  <div class="ant-form-item-control-input-content">
                                     <select class="ant-select ant-select-single ant-select-allow-clear ant-select-show-arrow ant-select-bordered" id="protocol" name="protocol" required>
                                         <option value="tcp">TCP</option>
                                         <option value="udp">UDP</option>
                                     </select>
                                  </div>
                              </div>
                         </div>
                     </div>
                     <div class="ant-form-item">
                          <div class="ant-form-item-control">
                              <button type="submit" class="ant-btn ant-btn-primary" id="addNatButton">添加规则</button>
                          </div>
                     </div>
                 </form>
             `;

            natModalInstance = AntdModal.modal({
                 title: `为容器 ${containerName} 添加 NAT 规则`,
                 content: natContent,
                 footer: null,
                 centered: true,
                 onCancel: () => { if(natModalInstance) natModalInstance.destroy(); natModalInstance = null; selectedContainerName = null; currentNatContainerIP = null;},
             });

             const natContainerIPInput = natModalInstance.$().find('#natContainerIP');
             const addNatButton = natModalInstance.$().find('#addNatButton');

             addNatButton.prop('disabled', true);

             $.ajax({
                 url: `/container/${containerName}/info`,
                 type: "GET",
                 headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                 success: function(data) {
                      if (data.status === 'NotFound' || data.status !== 'Running' || !data.ip || data.ip === 'N/A') {
                          const ipError = data.message || "无法获取容器 IP 地址或容器未运行。";
                          natContainerIPInput.val('获取 IP 失败: ' + (data.ip && data.ip === 'N/A' ? '未分配 IP' : data.status !== 'Running' ? '容器未运行' : ipError));
                          addNatButton.prop('disabled', true).find('span').text('无法添加 (无IP)');
                          showToast("无法添加 NAT 规则: " + (data.status !== 'Running' ? '容器未运行' : '无法获取IP'), 'warning');
                      } else {
                         natContainerIPInput.val(data.ip);
                         currentNatContainerIP = data.ip;
                         addNatButton.prop('disabled', false).find('span').text('添加规则');
                      }
                 },
                 error: function(jqXHR) {
                      if (jqXHR.status === 401) {
                          showToast("获取容器信息需要认证，请重新登录。", 'danger');
                          if (natModalInstance) { natModalInstance.destroy(); natModalInstance = null; selectedContainerName = null; currentNatContainerIP = null;}
                          setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                      } else {
                          natContainerIPInput.val('获取 IP 失败');
                          addNatButton.prop('disabled', true).find('span').text('无法添加 (无IP)');
                          const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "获取容器 IP 地址失败。";
                          showToast(message, 'danger');
                      }
                 }
             });

             $(document).off('submit', '#addNatForm').on('submit', '#addNatForm', function(event) {
                 event.preventDefault();
                 const form = $(this);
                 const submitButton = $('#addNatButton', form);

                 const containerName = $('#natContainerName').val();
                 const hostPort = $('#hostPort').val();
                 const containerPort = $('#containerPort').val();
                 const protocol = $('#protocol').val();
                 const containerIP = $('#natContainerIP').val();

                 if (!hostPort || !containerPort || !protocol) {
                     showToast("请填写所有 NAT 规则信息。", 'warning');
                     return;
                 }
                 if (!containerIP || containerIP.startsWith('获取 IP 失败') || containerIP === '正在获取 IP...') {
                      showToast("无法添加 NAT 规则，容器 IP 地址无效或未获取到。", 'warning');
                     return;
                 }


                 setButtonProcessing(submitButton, true);

                 $.ajax({
                     url: `/container/${containerName}/add_nat_rule`,
                     type: "POST",
                     data: {
                         host_port: hostPort,
                         container_port: containerPort,
                         protocol: protocol
                     },
                      headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
                     success: function(data) {
                         showToast(data.message, data.status);

                         if (data.status === 'success' || data.status === 'warning') {
                              if (infoModalInstance && selectedContainerName === containerName) {
                                  loadNatRules(containerName);
                              }

                              if (data.status === 'success') {
                                  $('#hostPort').val('');
                                  $('#containerPort').val('');
                                  $('#protocol').val('tcp');
                                  $('#natContainerIP').val(currentNatContainerIP); // Keep the fetched IP
                              }
                         }
                     },
                     error: function(jqXHR) {
                         if (jqXHR.status === 401) {
                              showToast("操作需要认证，请重新登录。", 'danger');
                              if (natModalInstance) { natModalInstance.destroy(); natModalInstance = null; selectedContainerName = null; currentNatContainerIP = null;}
                              setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                          } else {
                             const message = jqXHR.responseJSON ? (jqXHR.responseJSON.output || jqXHR.responseJSON.message || '未知错误') : "添加 NAT 规则请求失败。";
                             showToast(message, 'danger');
                          }
                     },
                     complete: function() {
                         setButtonProcessing(submitButton, false);
                     }
                 });
             });
        }
    </script>
</body>
</html>
