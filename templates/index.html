<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incus Web 管理器</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer utilities {
          .btn-processing {
            pointer-events: none;
            opacity: 0.7;
          }
            .spinner-border {
                display: inline-block;
                width: 1.5rem;
                height: 1.5rem;
                vertical-align: -0.125em;
                border: 0.25em solid currentColor;
                border-right-color: transparent;
                border-radius: 50%;
                -webkit-animation: .75s linear infinite spinner-border;
                animation: .75s linear infinite spinner-border;
            }

            .spinner-border-sm {
                width: 1rem;
                height: 1rem;
                border-width: 0.2em;
            }

            @-webkit-keyframes spinner-border {
                100% {
                    -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
                }
            }

            @keyframes spinner-border {
                100% {
                    -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
                }
            }
        }
    </style>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body class="pt-5">
    {% if session.logged_in %}
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center mb-6">
             <h1 class="text-2xl font-bold">Incus Web 管理器</h1>
             <a href="{{ url_for('logout') }}" class="inline-flex items-center px-3 py-1.5 border border-red-600 text-sm font-medium rounded-md text-red-600 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                退出登录
             </a>
        </div>

        {% if incus_error[0] %}
        <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-300" role="alert">
            <span class="font-bold">错误:</span> 无法连接到 Incus 或执行命令失败。显示的数据可能来自数据库缓存。 <br>
            详细信息: {{ incus_error[1] }}
        </div>
        {% endif %}

        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 rounded-t-lg">
                <h2 class="text-lg font-semibold text-gray-800">创建新容器</h2>
            </div>
            <div class="p-6">
                <form id="createContainerForm">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div class="md:col-span-4">
                            <label for="containerName" class="block text-sm font-medium text-gray-700">容器名称</label>
                            <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="containerName" name="name" required>
                        </div>
                        <div class="md:col-span-6">
                            <label for="containerImage" class="block text-sm font-medium text-gray-700">选择镜像</label>
                            <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="containerImage" name="image" required>
                                <option value="" selected disabled>请选择一个镜像</option>
                                {% for image in images %}
                                <option value="{{ image.name }}">{{ image.description }}</option>
                                {% endfor %}
                            </select>
                             {% if image_error[0] %}
                             <p class="mt-1 text-sm text-red-600">{{ image_error[1] }}</p>
                             {% endif %}
                        </div>
                        <div class="md:col-span-2 self-end">
                            <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="createButton">
                                创建容器
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-4">容器列表</h2>

        <div class="overflow-x-auto hidden md:block">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP 地址</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">镜像来源</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">操作</span></th>
                    </tr>
                </thead>
                <tbody id="containerListDesktop" class="bg-white divide-y divide-gray-200">
                    {% for c in containers %}
                    <tr class="{% cycle '' 'bg-gray-50' %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ c.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if c.status == 'Running' %} bg-green-100 text-green-800
                                {% elif c.status == 'Stopped' %} bg-red-100 text-red-800
                                {% else %} bg-gray-100 text-gray-800
                                {% endif %}">
                                {{ c.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ c.ip if c.ip and c.ip != 'N/A' else '-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ c.image_source if c.image_source else 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ c.created_at.split('T')[0] if c.created_at else 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex gap-1">
                                <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-blue-500 hover:bg-blue-600" onclick="showInfo('{{ c.name }}', this)">信息</button>
                                {% if c.status == 'Running' %}
                                <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-gray-800 bg-yellow-400 hover:bg-yellow-500" onclick="performAction('{{ c.name }}', 'stop', this)">停止</button>
                                <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="performAction('{{ c.name }}', 'restart', this)">重启</button>
                                <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="openExecModal('{{ c.name }}')">执行命令</button>
                                 <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-gray-800 hover:bg-gray-900" onclick="openNatModal('{{ c.name }}')">添加NAT</button>
                                {% elif c.status == 'Stopped' %}
                                <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" onclick="performAction('{{ c.name }}', 'start', this)">启动</button>
                                {% endif %}
                                <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" onclick="performAction('{{ c.name }}', 'delete', this)">删除</button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">没有找到容器或无法连接到 Incus。</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="block md:hidden mt-6">
            {% for c in containers %}
            <div class="bg-white shadow rounded-lg mb-4">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="text-lg font-semibold mb-0 break-words">{{ c.name }}</h5>
                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if c.status == 'Running' %} bg-green-100 text-green-800
                                {% elif c.status == 'Stopped' %} bg-red-100 text-red-800
                                {% else %} bg-gray-100 text-gray-800
                                {% endif %}">
                            {{ c.status }}
                        </span>
                    </div>

                    <p class="text-sm text-gray-700 mb-1"><small class="font-bold text-gray-500 mr-1">IP 地址:</small> {{ c.ip if c.ip and c.ip != 'N/A' else '-' }}</p>
                    <p class="text-sm text-gray-700 mb-1"><small class="font-bold text-gray-500 mr-1">镜像:</small> {{ c.image_source if c.image_source else 'N/A' }}</p>
                    <p class="text-sm text-gray-700 mb-3"><small class="font-bold text-gray-500 mr-1">创建时间:</small> {{ c.created_at.split('T')[0] if c.created_at else 'N/A' }}</p>

                    <div class="mt-4 flex flex-wrap gap-2">
                        <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-blue-500 hover:bg-blue-600" onclick="showInfo('{{ c.name }}', this)">信息</button>
                        {% if c.status == 'Running' %}
                        <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-gray-800 bg-yellow-400 hover:bg-yellow-500" onclick="performAction('{{ c.name }}', 'stop', this)">停止</button>
                        <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="performAction('{{ c.name }}', 'restart', this)">重启</button>
                        <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="openExecModal('{{ c.name }}')">执行命令</button>
                         <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-gray-800 hover:bg-gray-900" onclick="openNatModal('{{ c.name }}')">添加NAT</button>
                        {% elif c.status == 'Stopped' %}
                        <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" onclick="performAction('{{ c.name }}', 'start', this)">启动</button>
                        {% endif %}
                        <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" onclick="performAction('{{ c.name }}', 'delete', this)">删除</button>
                    </div>
                </div>
            </div>
            {% else %}
             <div class="p-4 text-sm text-blue-800 rounded-lg bg-blue-50 border border-blue-300 text-center" role="alert">
                 没有找到容器或无法连接到 Incus。
            </div>
            {% endfor %}
        </div>

         <button class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="location.reload()">刷新列表</button>
    </div>
    {% else %}
    <div class="container mx-auto px-4">
        <div class="max-w-sm mx-auto mt-12 p-6 border border-gray-300 rounded-lg bg-gray-50">
             <h2 class="text-xl font-semibold text-center mb-6">管理员登录</h2>
             <form method="POST" action="{{ url_for('login') }}">
                 <input type="hidden" name="next" value="{{ request.args.get('next', '') }}">
                 <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">用户名</label>
                    <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="username" name="username" required autofocus>
                 </div>
                  <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
                    <input type="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="password" name="password" required>
                 </div>
                 {% if login_error %}
                 <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-300" role="alert">
                     {{ login_error }}
                 </div>
                 {% endif %}
                 <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    登录
                 </button>
             </form>
        </div>
    </div>
    {% endif %}


    <div id="toastContainer" class="fixed top-4 right-4 z-[1050] space-y-2">
    </div>

    <div id="infoModal" tabindex="-1" aria-hidden="true" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden items-center justify-center z-[1050]">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden max-w-3xl w-full m-4">
            <div class="px-6 py-4 bg-gray-50 flex justify-between items-center border-b border-gray-200">
                <h5 class="text-lg font-medium text-gray-900" id="infoModalLabel">容器信息</h5>
                <button type="button" class="text-gray-400 hover:text-gray-500" onclick="$('#infoModal').addClass('hidden').removeClass('flex');" aria-label="Close">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="px-6 py-6 overflow-y-auto max-h-[80vh]">
                <div id="basicInfoContent">正在加载基础信息...</div>

                <div id="natRulesList" class="mt-6 pt-4 border-t border-gray-200">
                    <h6 class="text-base font-semibold mb-3">NAT 规则 (本应用添加)</h6>
                    <ul id="natRulesContent" class="list-none p-0">
                        <li>正在加载 NAT 规则...</li>
                    </ul>
                     <div id="natRulesError" class="mt-4 p-3 text-sm text-yellow-800 rounded-lg bg-yellow-50 border border-yellow-300 hidden"></div>
                </div>

                 <div id="infoError" class="mt-4 p-3 text-sm text-red-800 rounded-lg bg-red-50 border border-red-300 hidden"></div>

            </div>
        </div>
    </div>

    <div id="execModal" tabindex="-1" aria-hidden="true" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden items-center justify-center z-[1050]">
         <div class="bg-white rounded-lg shadow-xl overflow-hidden max-w-3xl w-full m-4">
             <div class="px-6 py-4 bg-gray-50 flex justify-between items-center border-b border-gray-200">
                <h5 class="text-lg font-medium text-gray-900" id="execModalLabel">在容器内执行命令</h5>
                 <button type="button" class="text-gray-400 hover:text-gray-500" onclick="$('#execModal').addClass('hidden').removeClass('flex');" aria-label="Close">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="px-6 py-6 overflow-y-auto max-h-[80vh]">
                <form id="execCommandForm">
                    <input type="hidden" id="execContainerName" name="container_name">
                    <div class="mb-4">
                        <label for="commandInput" class="block text-sm font-medium text-gray-700">命令 (例如: ls -l / 或 apt update)</label>
                        <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="commandInput" name="command" required>
                    </div>
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="execButton">
                        执行
                    </button>
                </form>
                <h6 class="mt-6 text-base font-semibold">输出:</h6>
                <pre id="execOutput" class="mt-4 whitespace-pre-wrap bg-gray-100 border border-gray-300 p-4 max-h-72 overflow-y-auto font-mono text-sm"></pre>
            </div>
        </div>
    </div>

    <div id="natModal" tabindex="-1" aria-hidden="true" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden items-center justify-center z-[1050]">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden max-w-lg w-full m-4">
            <div class="px-6 py-4 bg-gray-50 flex justify-between items-center border-b border-gray-200">
                <h5 class="text-lg font-medium text-gray-900" id="natModalLabel">为容器添加 NAT 规则</h5>
                 <button type="button" class="text-gray-400 hover:text-gray-500" onclick="$('#natModal').addClass('hidden').removeClass('flex');" aria-label="Close">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="px-6 py-6 overflow-y-auto max-h-[80vh]">
                <div class="p-4 mb-4 text-sm text-yellow-800 rounded-lg bg-yellow-50 border border-yellow-300" role="alert">
                    注意：这将在主机上添加一个临时的 iptables NAT 规则。规则在主机重启后会丢失，且需要此Web应用以足够权限(如 root 或 sudo)运行。
                     成功添加规则时，iptables命令通常没有输出内容。
                </div>
                <form id="addNatForm">
                    <input type="hidden" id="natContainerName" name="container_name">
                     <div class="mb-4">
                        <label for="natContainerIP" class="block text-sm font-medium text-gray-700">容器 IP 地址 (添加规则时获取)</label>
                        <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 cursor-not-allowed sm:text-sm" id="natContainerIP" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="hostPort" class="block text-sm font-medium text-gray-700">主机端口</label>
                        <input type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="hostPort" name="host_port" required min="1" max="65535">
                    </div>
                     <div class="mb-4">
                        <label for="containerPort" class="block text-sm font-medium text-gray-700">容器端口</label>
                        <input type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="containerPort" name="container_port" required min="1" max="65535">
                    </div>
                    <div class="mb-6">
                        <label for="protocol" class="block text-sm font-medium text-gray-700">协议</label>
                        <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" id="protocol" name="protocol" required>
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="addNatButton">
                        添加规则
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="confirmModal" tabindex="-1" aria-hidden="true" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden items-center justify-center z-[1050]">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden max-w-sm w-full m-4">
             <div class="px-6 py-4 bg-gray-50 flex justify-between items-center border-b border-gray-200">
                <h5 class="text-lg font-medium text-gray-900" id="confirmModalLabel">请确认</h5>
                 <button type="button" class="text-gray-400 hover:text-gray-500" onclick="$('#confirmModal').addClass('hidden').removeClass('flex');" aria-label="Close">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="px-6 py-6" id="confirmModalBody">
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-2">
                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300" onclick="$('#confirmModal').addClass('hidden').removeClass('flex');">取消</button>
                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="confirmActionButton">确认</button>
            </div>
        </div>
    </div>


<script>
function showToast(message, type = 'info') {
    let bgColorClass = 'bg-blue-500';
    let textColorClass = 'text-white';

    if (type === 'success') {
        bgColorClass = 'bg-green-500';
    } else if (type === 'error') {
        bgColorClass = 'bg-red-500';
    } else if (type === 'warning') {
        bgColorClass = 'bg-yellow-500';
        textColorClass = 'text-gray-800';
    }

    const toastContainer = $('#toastContainer');
    const toastHtml = `
        <div class="flex items-center p-4 rounded-lg shadow-md border border-gray-200 ${bgColorClass} ${textColorClass} toast">
            <div class="mr-3 text-sm font-normal flex-grow">
                ${message}
            </div>
            <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-current rounded-lg p-1.5 inline-flex items-center justify-center h-8 w-8" onclick="$(this).closest('.toast').remove();" aria-label="Close">
                <span class="sr-only">Close</span>
                 <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
            </button>
        </div>
    `;
    const toastElement = $(toastHtml);
    toastContainer.append(toastElement);

    setTimeout(() => {
        toastElement.remove();
    }, 5000);
}


function setButtonProcessing(button, isProcessing) {
    const $button = $(button);
    if (!$button.length) {
         console.warn("Button element not found for processing state update.");
         return;
    }

    if (isProcessing) {
        if (!$button.data('original-html')) {
            $button.data('original-html', $button.html());
            const originalText = $button.text().trim();
            const spinnerHtml = '<span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span>';
            $button.html(spinnerHtml + (originalText ? ' 处理中...' : ''));
            $button.addClass('btn-processing').prop('disabled', true);
        }
    } else {
        if ($button.data('original-html')) {
             $button.html($button.data('original-html'));
             $button.data('original-html', null);
             $button.removeClass('btn-processing').prop('disabled', false);
        } else {
             $button.removeClass('btn-processing').prop('disabled', false);
        }
    }
}

let currentConfirmAction = null;
let currentConfirmContainerName = null;
let currentConfirmRuleId = null;
let currentConfirmButtonElement = null;


function showTailwindModal(modalId) {
    const $modal = $(`#${modalId}`);
    if ($modal.length) {
        $modal.removeClass('hidden').addClass('flex');
    }
}

function hideTailwindModal(modalId) {
     const $modal = $(`#${modalId}`);
    if ($modal.length) {
        $modal.addClass('hidden').removeClass('flex');
    }
}


function showConfirmationModal(actionType, nameOrId, buttonElement) {
    currentConfirmAction = actionType;
    currentConfirmButtonElement = buttonElement;
    const modalTitle = $('#confirmModalLabel');
    const modalBody = $('#confirmModalBody');
    const confirmButton = $('#confirmActionButton');

    let message = '';
    let buttonClass = 'bg-indigo-600 hover:bg-indigo-700';
    let buttonText = '确认';

    if (actionType === 'restart_container') {
        currentConfirmContainerName = nameOrId;
        currentConfirmRuleId = null;
        modalTitle.text('确认重启');
        message = `确定要重启容器 <strong>${nameOrId}</strong> 吗？`;
        buttonClass = 'bg-yellow-500 hover:bg-yellow-600 text-gray-800';
        buttonText = '重启';
    } else if (actionType === 'delete_container') {
        currentConfirmContainerName = nameOrId;
         currentConfirmRuleId = null;
        modalTitle.text('确认删除容器');
        message = `<strong>警告：</strong> 这将永久删除容器 <strong>${nameOrId}</strong> 及其所有数据！<br>同时将强制删除所有通过本应用添加的关联 NAT 规则。<br>确定删除吗？`;
        buttonClass = 'bg-red-600 hover:bg-red-700';
        buttonText = '删除容器';
     } else if (actionType === 'delete_nat_rule') {
         currentConfirmContainerName = null;
         currentConfirmRuleId = nameOrId;
        modalTitle.text('确认删除 NAT 规则');
        message = `确定要删除 ID 为 <strong>${nameOrId}</strong> 的 NAT 规则吗？此操作将尝试移除对应的 iptables 规则记录 (仅针对通过本应用添加的规则)。`;
        buttonClass = 'bg-red-600 hover:bg-red-700';
        buttonText = '删除规则';
    }

    modalBody.html(message);
    confirmButton.removeClass('bg-indigo-600 hover:bg-indigo-700 bg-yellow-500 hover:bg-yellow-600 text-gray-800 bg-red-600 hover:bg-red-700').addClass(buttonClass).text(buttonText);
    setButtonProcessing(confirmButton, false);

    showTailwindModal('confirmModal');
}


$('#confirmActionButton').click(function() {
    const actionType = currentConfirmAction;
    const buttonElement = currentConfirmButtonElement;
    const confirmButton = $(this);

    if (!actionType || !buttonElement) {
        showToast("确认信息丢失，无法执行操作。", 'error');
        hideTailwindModal('confirmModal');
        return;
    }

    setButtonProcessing(confirmButton, true);
     if (actionType !== 'delete_nat_rule') {
        setButtonProcessing(buttonElement, true);
     }


    if (actionType === 'delete_nat_rule') {
        const ruleId = currentConfirmRuleId;
        $.ajax({
            url: `/container/nat_rule/${ruleId}`,
            type: 'DELETE',
            headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
            success: function(data) {
                showToast(data.message, data.status);
                if (data.status === 'success' || data.status === 'warning') {
                    const containerNameInModalLabel = $('#infoModalLabel').text().replace('容器信息: ', '');
                    if (containerNameInModalLabel) {
                        loadNatRules(containerNameInModalLabel);
                    } else {
                         setTimeout(() => location.reload(), 1000);
                    }
                }
            },
            error: function(jqXHR) {
                if (jqXHR.status === 401) {
                    showToast("操作需要认证，请重新登录。", 'error');
                    hideTailwindModal('confirmModal');
                    setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
                } else {
                    const message = jqXHR.responseJSON ? (jqXHR.responseJSON.message || "未知错误") : `删除 NAT 规则请求失败。`;
                    showToast("操作失败: " + message, 'error');
                }
            },
            complete: function() {
                hideTailwindModal('confirmModal');
                setButtonProcessing(buttonElement, false);
                setButtonProcessing(confirmButton, false);
            }
        });

    } else {
        const containerName = currentConfirmContainerName;
        let action = actionType.replace('_container', '');

        $.post(`/container/${containerName}/action`, { action: action }, function(data) {
            showToast(data.message, data.status);
            if (data.status === 'success') {
                 setTimeout(() => location.reload(), 1000);
            } else {
                 setButtonProcessing(buttonElement, false);
            }
        }).fail(function(jqXHR) {
             if (jqXHR.status === 401) {
                showToast("操作需要认证，请重新登录。", 'error');
                 hideTailwindModal('confirmModal');
                setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                const message = jqXHR.responseJSON ? (jqXHR.responseJSON.message || "未知错误") : `执行 ${action} 操作请求失败。`;
                showToast("操作失败: " + message, 'error');
                setButtonProcessing(buttonElement, false);
             }
        }).always(function() {
            hideTailwindModal('confirmModal');
             setButtonProcessing(confirmButton, false);
        });
    }
});

$('#confirmModal').click(function(e) {
    if ($(e.target).is('#confirmModal') || $(e.target).closest('button[aria-label="Close"]').length) {
         hideTailwindModal('confirmModal');
         currentConfirmAction = null;
         currentConfirmContainerName = null;
         currentConfirmRuleId = null;
    }
});


$('#createContainerForm').submit(function(event) {
    event.preventDefault();
    const form = $(this);
    const submitButton = $('#createButton', form);
    setButtonProcessing(submitButton, true);

    var formData = form.serialize();
    $.ajax({
        url: "{{ url_for('create_container') }}",
        type: "POST",
        data: formData,
        headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
        success: function(data) {
            showToast(data.message, data.status);
            if (data.status === 'success') {
                form[0].reset();
                 setTimeout(() => location.reload(), 1000);
            }
        },
        error: function(jqXHR) {
             if (jqXHR.status === 401) {
                showToast("操作需要认证，请重新登录。", 'error');
                setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "创建容器请求失败。";
                showToast("错误: " + message, 'error');
             }
        },
        complete: function() {
            setButtonProcessing(submitButton, false);
        }
    });
});

function performAction(containerName, action, buttonElement) {

    if (action === 'restart') {
        showConfirmationModal('restart_container', containerName, buttonElement);
        return;
    }
    if (action === 'delete') {
        showConfirmationModal('delete_container', containerName, buttonElement);
        return;
    }

    setButtonProcessing(buttonElement, true);

    $.ajax({
        url: `/container/${containerName}/action`,
        type: "POST",
        data: { action: action },
        headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
        success: function(data) {
            showToast(data.message, data.status);
            if (data.status === 'success') {
                 setTimeout(() => location.reload(), 1000);
            } else {
                 setButtonProcessing(buttonElement, false);
            }
        },
        error: function(jqXHR) {
             if (jqXHR.status === 401) {
                showToast("操作需要认证，请重新登录。", 'error');
                setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                const message = jqXHR.responseJSON ? (jqXHR.responseJSON.message || "未知错误") : `执行 ${action} 操作请求失败。`;
                showToast("操作失败: " + message, 'error');
                setButtonProcessing(buttonElement, false);
             }
        }
    });
}

function showInfo(containerName, buttonElement) {
    const basicInfoContent = $('#basicInfoContent');
    const natRulesListContainer = $('#natRulesList');
    const natRulesContent = $('#natRulesContent');
    const natRulesError = $('#natRulesError');
    const infoError = $('#infoError');


    $('#infoModalLabel').text(`容器信息: ${containerName}`);
    basicInfoContent.html('正在加载基础信息...');
    natRulesContent.html('<li class="p-2 bg-gray-100 rounded mb-1 border border-gray-200 text-sm">正在加载 NAT 规则...</li>');
    natRulesError.addClass('hidden').text('');
     infoError.addClass('hidden').text('');

    natRulesListContainer.removeClass('hidden');

    setButtonProcessing(buttonElement, true);

    $.ajax({
        url: `/container/${containerName}/info`,
        type: "GET",
        headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
        success: function(data) {
             if (data.status === 'NotFound') {
                 basicInfoContent.html(`<p class="text-red-600 font-bold">错误:</p> <p>${data.message}</p>`);
                 infoError.removeClass('hidden').text(data.message);
                 showToast("加载容器信息失败。", 'error');
                 natRulesListContainer.addClass('hidden');
                 return;
            }

            let infoHtml = `
                <p class="mb-2"><strong class="font-semibold">名称:</strong> ${data.name}</p>
                <p class="mb-2"><strong class="font-semibold">状态:</strong> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    ${data.status === 'Running' ? 'bg-green-100 text-green-800' : data.status === 'Stopped' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                    ${data.status}
                </span> (代码: ${data.status_code})</p>
                <p class="mb-2"><strong class="font-semibold">IP 地址:</strong> ${data.ip && data.ip !== 'N/A' ? data.ip : '-'}</p>
                <p class="mb-2"><strong class="font-semibold">镜像来源/描述:</strong> ${data.description && data.description !== 'N/A' ? data.description : data.image_source && data.image_source !== 'N/A' ? data.image_source : 'N/A'}</p>
                <p class="mb-2"><strong class="font-semibold">创建时间:</strong> ${data.created_at ? data.created_at.split('T')[0] : 'N/A'}</p>
                <p class="mb-2"><strong class="font-semibold">架构:</strong> ${data.architecture && data.architecture !== 'N/A' ? data.architecture : 'N/A'}</p>
                <p class="mb-2"><strong class="font-semibold">类型:</strong> ${data.type}</p>
                 <p class="mb-2"><strong class="font-semibold">临时容器:</strong> ${data.ephemeral ? '是' : '否'}</p>
                <p class="mb-2"><strong class="font-semibold">配置文件:</strong> ${data.profiles.join(', ') || '无'}</p>
                 <p class="mt-4 text-sm text-gray-600">${data.message}</p>
            `;

            basicInfoContent.html(infoHtml);

            if (!data.live_data_available && data.status !== 'NotFound') {
                 showToast(data.message, 'warning');
            }

            loadNatRules(containerName);

        },
        error: function(jqXHR) {
             if (jqXHR.status === 401) {
                showToast("操作需要认证，请重新登录。", 'error');
                hideTailwindModal('infoModal');
                setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "请求失败，无法加载详细信息。";
                basicInfoContent.html(`<p class="text-red-600 font-bold">错误:</p> <p>${message}</p>`);
                infoError.removeClass('hidden').text(message);
                natRulesContent.html('<li class="p-2 bg-red-50 rounded mb-1 border border-red-300 text-red-800 text-sm">无法加载 NAT 规则。</li>');
                natRulesListContainer.removeClass('hidden');
                showToast("加载容器信息失败。", 'error');
             }
        },
        complete: function() {
            setButtonProcessing(buttonElement, false);
            showTailwindModal('infoModal');
        }
    });
}

function loadNatRules(containerName) {
    const natRulesContent = $('#natRulesContent');
     const natRulesError = $('#natRulesError');
    natRulesContent.html('<li class="p-2 bg-gray-100 rounded mb-1 border border-gray-200 text-sm">正在加载 NAT 规则...</li>');
    natRulesError.addClass('hidden').text('');

     $.ajax({
        url: `/container/${containerName}/nat_rules`,
        type: "GET",
        headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
        success: function(data) {
            natRulesContent.empty();

            if (data.status === 'success' && data.rules && data.rules.length > 0) {
                data.rules.forEach(rule => {
                    const ruleHtml = `
                        <li data-rule-id="${rule.id}" class="flex justify-between items-center flex-wrap bg-gray-100 border border-gray-200 mb-2 p-3 rounded-md gap-2">
                            <span class="flex-grow mr-2 break-words text-sm text-gray-700">
                                <strong class="font-semibold">ID ${rule.id}:</strong> 主机 ${rule.host_port}/${rule.protocol} → 容器 ${rule.ip_at_creation}:${rule.container_port}
                                <br><small class="text-gray-500">记录创建时间: ${rule.created_at ? new Date(rule.created_at).toLocaleString() : 'N/A'}</small>
                            </span>
                            <span class="flex-shrink-0 ml-auto">
                                 <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" onclick="deleteNatRule(${rule.id}, this)">删除</button>
                            </span>
                        </li>
                    `;
                    natRulesContent.append(ruleHtml);
                });
            } else if (data.status === 'success' && data.rules && data.rules.length === 0) {
                natRulesContent.html('<li class="p-2 bg-gray-100 rounded mb-1 border border-gray-200 text-sm text-gray-700">没有通过本应用添加的 NAT 规则记录。</li>');
            } else {
                 natRulesContent.html('<li class="p-2 bg-red-50 rounded mb-1 border border-red-300 text-red-800 text-sm">加载 NAT 规则失败。</li>');
                 natRulesError.removeClass('hidden').text(data.message || '未知错误获取规则列表。');
                 showToast(data.message || "加载 NAT 规则失败。", 'error');
            }
        },
        error: function(jqXHR) {
             if (jqXHR.status === 401) {
                showToast("加载 NAT 规则需要认证，请重新登录。", 'error');
                 hideTailwindModal('infoModal');
                setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                 const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "请求失败，无法加载 NAT 规则。";
                 natRulesContent.html('<li class="p-2 bg-red-50 rounded mb-1 border border-red-300 text-red-800 text-sm">加载 NAT 规则失败。</li>');
                 natRulesError.removeClass('hidden').text(message);
                 showToast(message, 'error');
             }
        }
    });
}


function deleteNatRule(ruleId, buttonElement) {
    showConfirmationModal('delete_nat_rule', ruleId, buttonElement);
}


function openExecModal(containerName) {
    $('#execContainerName').val(containerName);
    $('#execModalLabel').text(`在 ${containerName} 内执行命令`);
    $('#commandInput').val('');
    $('#execOutput').text('');
    $('#execOutput').removeClass('bg-green-50 text-green-800 border-green-300 bg-red-50 text-red-800 border-red-300');
    $('#execOutput').addClass('bg-gray-100 border-gray-300');
    setButtonProcessing($('#execButton'), false);
    showTailwindModal('execModal');
}

$('#execCommandForm').submit(function(event) {
    event.preventDefault();
    const form = $(this);
    const submitButton = $('#execButton', form);
    const outputArea = $('#execOutput');

    var containerName = $('#execContainerName').val();
    var command = $('#commandInput').val();

    if (!command.trim()) {
        showToast("请输入要执行的命令。", 'warning');
        return;
    }

    outputArea.text('正在执行...');
    outputArea.removeClass('bg-green-50 text-green-800 border-green-300 bg-red-50 text-red-800 border-red-300');
    outputArea.addClass('bg-gray-100 border-gray-300');


    setButtonProcessing(submitButton, true);

    $.ajax({
        url: `/container/${containerName}/exec`,
        type: "POST",
        data: { command: command },
        headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
        success: function(data) {
            if (data.status === 'success') {
                outputArea.text(data.output);
                 outputArea.removeClass('bg-gray-100 border-gray-300 bg-red-50 text-red-800 border-red-300');
                outputArea.addClass('bg-green-50 text-green-800 border-green-300');
                showToast("命令执行成功。", 'success');
            } else {
                outputArea.text('命令执行失败:\n' + (data.output || data.message || '无详细输出'));
                 outputArea.removeClass('bg-gray-100 border-gray-300 bg-green-50 text-green-800 border-green-300');
                outputArea.addClass('bg-red-50 text-red-800 border-red-300');
                showToast(data.message || "命令执行失败。", 'error');
            }
        },
        error: function(jqXHR) {
             if (jqXHR.status === 401) {
                showToast("操作需要认证，请重新登录。", 'error');
                 hideTailwindModal('execModal');
                setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                const message = jqXHR.responseJSON ? (jqXHR.responseJSON.output || jqXHR.responseJSON.message || '未知错误') : "执行命令请求失败。";
                outputArea.text("请求失败:\n" + message);
                 outputArea.removeClass('bg-gray-100 border-gray-300 bg-green-50 text-green-800 border-green-300');
                outputArea.addClass('bg-red-50 text-red-800 border-red-300');
                showToast("请求失败。", 'error');
             }
        },
        complete: function() {
            setButtonProcessing(submitButton, false);
        }
    });
});

function openNatModal(containerName) {
    $('#natContainerName').val(containerName);
    $('#natModalLabel').text(`为容器 ${containerName} 添加 NAT 规则`);
    $('#hostPort').val('');
    $('#containerPort').val('');
    $('#protocol').val('tcp');
    $('#natContainerIP').val('正在获取 IP...');
    setButtonProcessing($('#addNatButton'), false);
    $('#addNatButton').prop('disabled', true).text('获取 IP...');

    showTailwindModal('natModal');


    $.ajax({
        url: `/container/${containerName}/info`,
        type: "GET",
        headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
        success: function(data) {
             if (data.status === 'NotFound' || data.status !== 'Running' || !data.ip || data.ip === 'N/A') {
                 const ipError = data.message || "无法获取容器 IP 地址或容器未运行。";
                 $('#natContainerIP').val('获取 IP 失败: ' + (data.ip && data.ip === 'N/A' ? '未分配 IP' : data.status !== 'Running' ? '容器未运行' : ipError));
                 $('#addNatButton').prop('disabled', true).text('无法添加 (无IP)');
                 showToast("无法添加 NAT 规则: " + (data.status !== 'Running' ? '容器未运行' : '无法获取IP'), 'warning');
             } else {
                $('#natContainerIP').val(data.ip);
                $('#addNatButton').prop('disabled', false).text('添加规则');
             }
        },
        error: function(jqXHR) {
             if (jqXHR.status === 401) {
                 showToast("获取容器信息需要认证，请重新登录。", 'error');
                 hideTailwindModal('natModal');
                 setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                 $('#natContainerIP').val('获取 IP 失败');
                 $('#addNatButton').prop('disabled', true).text('无法添加 (无IP)');
                 const message = jqXHR.responseJSON ? jqXHR.responseJSON.message : "获取容器 IP 地址失败。";
                 showToast(message, 'error');
             }
        }
    });
});

$('#addNatForm').submit(function(event) {
    event.preventDefault();
    const form = $(this);
    const submitButton = $('#addNatButton', form);

    const containerName = $('#natContainerName').val();
    const hostPort = $('#hostPort').val();
    const containerPort = $('#containerPort').val();
    const protocol = $('#protocol').val();

    if (!hostPort || !containerPort || !protocol) {
        showToast("请填写所有 NAT 规则信息。", 'warning');
        return;
    }

    setButtonProcessing(submitButton, true);

    $.ajax({
        url: `/container/${containerName}/add_nat_rule`,
        type: "POST",
        data: {
            host_port: hostPort,
            container_port: containerPort,
            protocol: protocol
        },
         headers: { 'X-API-Hash': '{{ API_SECRET_HASH }}' },
        success: function(data) {
            showToast(data.message, data.status);

            if (data.status === 'success' || data.status === 'warning') {
                 const containerNameInInfoModal = $('#infoModalLabel').text().replace('容器信息: ', '');
                 if (containerNameInInfoModal === containerName) {
                     loadNatRules(containerName);
                 }

                 if (data.status === 'success') {
                     $('#hostPort').val('');
                     $('#containerPort').val('');
                     $('#protocol').val('tcp');
                 }
            }
        },
        error: function(jqXHR) {
            if (jqXHR.status === 401) {
                 showToast("操作需要认证，请重新登录。", 'error');
                 hideTailwindModal('natModal');
                 setTimeout(() => window.location.href = "{{ url_for('login', next=request.url) }}", 1000);
             } else {
                const message = jqXHR.responseJSON ? (jqXHR.responseJSON.output || jqXHR.responseJSON.message || '未知错误') : "添加 NAT 规则请求失败。";
                showToast(message, 'error');
             }
        },
        complete: function() {
            setButtonProcessing(submitButton, false);
        }
    });
});


$('#infoModal').click(function(e) {
    if ($(e.target).is('#infoModal') || $(e.target).closest('button[aria-label="Close"]').length) {
        hideTailwindModal('infoModal');
        $('#basicInfoContent').html('正在加载基础信息...');
        $('#natRulesContent').html('<li class="p-2 bg-gray-100 rounded mb-1 border border-gray-200 text-sm">正在加载 NAT 规则...</li>');
        $('#natRulesError').addClass('hidden').text('');
        $('#infoError').addClass('hidden').text('');
        $('#infoModalLabel').text('容器信息');
        $('#natRulesList').addClass('hidden');
    }
});

$('#execModal').click(function(e) {
    if ($(e.target).is('#execModal') || $(e.target).closest('button[aria-label="Close"]').length) {
        hideTailwindModal('execModal');
        $('#execContainerName').val('');
        $('#commandInput').val('');
        $('#execOutput').text('');
        $('#execOutput').removeClass('bg-green-50 text-green-800 border-green-300 bg-red-50 text-red-800 border-red-300');
        $('#execOutput').addClass('bg-gray-100 border-gray-300');
        $('#execModalLabel').text('在容器内执行命令');
        setButtonProcessing($('#execButton'), false);
    }
});

$('#natModal').click(function(e) {
    if ($(e.target).is('#natModal') || $(e.target).closest('button[aria-label="Close"]').length) {
        hideTailwindModal('natModal');
        $('#natContainerName').val('');
        $('#natContainerIP').val('');
        $('#hostPort').val('');
        $('#containerPort').val('');
        $('#protocol').val('tcp');
        $('#natModalLabel').text('为容器添加 NAT 规则');
        setButtonProcessing($('#addNatButton'), false);
         $('#addNatButton').prop('disabled', false).text('添加规则');
    }
});


</script>
</body>
</html>
