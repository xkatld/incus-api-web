<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incus Web 管理器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
            color: #3c4043;
        }
        body.login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
        }
        .main-content { padding-top: 1.5rem; padding-bottom: 2rem; }
        h1.page-title { font-size: 1.75rem; color: #1a73e8; }
        h2.section-title { font-size: 1.3rem; margin-top: 0; margin-bottom: 1rem; padding-bottom: 0.5rem; color: #202124; }
        .left-column h2.section-title { border-bottom: 1px solid #e0e0e0; }
        .right-column .section-title { padding-bottom: 0.25rem; margin-bottom: 0.75rem; }

        .btn {
            border-radius: 4px; font-weight: 500; padding: 0.5rem 1rem;
            font-size: 0.875rem; transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            text-transform: none;
        }
        .btn-primary { background-color: #1a73e8; border-color: #1a73e8; }
        .btn-primary:hover, .btn-primary:focus { background-color: #1765cc; border-color: #1765cc; box-shadow: 0 1px 2px 0 rgba(66,133,244,.3),0 1px 3px 1px rgba(66,133,244,.15); }
        .btn-secondary { background-color: #dadce0; border-color: #dadce0; color: #3c4043; }
        .btn-secondary:hover, .btn-secondary:focus { background-color: #c8cbcf; border-color: #c8cbcf; box-shadow: 0 1px 2px 0 rgba(0,0,0,.1),0 1px 3px 1px rgba(0,0,0,.08); }
        .btn-outline-secondary { color: #5f6368; border-color: #dadce0; }
        .btn-outline-secondary:hover { background-color: #f1f3f4; color: #202124; border-color: #dadce0; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.75rem; }
        .dropdown-item { font-size: 0.875rem; padding: 0.35rem 1rem; }
        .dropdown-menu {
            border-radius: 4px;
            box-shadow: 0 2px 5px 0 rgba(0,0,0,.1), 0 2px 10px 0 rgba(0,0,0,.08);
            border: 1px solid #e0e0e0;
            z-index: 1021;
        }
        .dropdown-toggle::after { margin-left: .355em; }

        .form-control, .form-select {
            border-radius: 4px; border: 1px solid #dadce0; padding: 0.6rem 0.75rem;
            font-size: 0.9rem; background-color: #fff;
        }
        .form-control:focus, .form-select:focus { border-color: #1a73e8; box-shadow: 0 0 0 1px #1a73e8; background-color: #fff; }
        .form-label { font-weight: 500; color: #5f6368; font-size: 0.875rem; margin-bottom: 0.3rem; }

        .container-list-desktop {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
            overflow-x: hidden; 
            overflow-y: visible; 
        }
        .table {
            table-layout: fixed;
            width: 100%;
            background-color: #fff;
            margin-bottom: 0;
        }
        .table th, .table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            border-top: 1px solid #e0e0e0;
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .table thead th {
            font-weight: 500; color: #5f6368;
            border-bottom: 2px solid #d1d3d6; background-color: #f8f9fa; border-top: 0;
        }
        .table-hover > tbody > tr:hover > * { background-color: rgba(26,115,232,.05); }

        .table th.col-name, .table td.col-name { width: 25%; }
        .table th.col-status, .table td.col-status { width: 10%; text-align: center;}
        .table th.col-ip, .table td.col-ip { width: 15%; }
        .table th.col-image, .table td.col-image { width: 20%; }
        .table th.col-created, .table td.col-created { width: 15%; }
        .table th.col-actions, .table td.col-actions {
            width: 15%;
            text-align: end;
            overflow: visible; 
        }

        #loginFormContainer { 
            max-width: 400px; 
            margin-left: auto;
            margin-right: auto;
            /* padding: 2rem 0; original padding */
        }
        #loginFormContainer .form-title { text-align: center; font-size: 1.75rem; color: #202124; margin-bottom: 1.5rem; }

        #execOutput { white-space: pre-wrap; background-color: #f1f3f4; border:1px solid #dadce0; padding:1rem; max-height:350px; overflow-y:auto; font-family:'Roboto Mono',monospace; font-size:.85em; border-radius:4px;}
        #execOutput.success { border-color: #81c995; background-color: #e6f4ea; color: #185c37; }
        #execOutput.error { border-color: #f28b82; background-color: #fce8e6; color: #a50e0e; }
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 1090; }
        .toast { border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,.18); font-size:.9rem; }
        .modal-content { border-radius:8px; border:1px solid #dadce0; box-shadow:0 4px 8px 0 rgba(60,64,67,.3),0 6px 20px 0 rgba(60,64,67,.15); }
        .modal-header { background-color:#fff; border-bottom:1px solid #e0e0e0; padding:1rem 1.5rem; }
        .modal-footer { background-color:#f8f9fa; border-top:1px solid #e0e0e0; padding:.75rem 1.5rem; }

        .container-list-mobile .card { background-color:#fff; border:1px solid #e0e0e0; box-shadow:0 1px 2px 0 rgba(60,64,67,.08),0 1px 3px 1px rgba(60,64,67,.05); border-radius:8px; }
        .container-list-mobile .card-footer { background-color:#fff; border-top:1px solid #e0e0e0; padding:.75rem 1rem; }
        .container-list-mobile .card-actions-dropdown .btn { width: 100%; }

        #natRulesList li { background-color:#fff; border:1px solid #e0e0e0; margin-bottom:.75rem; padding:.75rem 1rem; border-radius:4px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; font-size:.85rem; }
        #natRulesList li:hover { background-color:#f1f3f4; }

        .sticky-top-form-container { 
            position: sticky; 
            top: 20px; 
        }
        .create-form-panel { background-color: #fff; padding: 1.25rem; border-radius: 8px; border: 1px solid #e0e0e0; }
        .offcanvas-header { border-bottom:1px solid #e0e0e0; }
      
    </style>
</head>
<body {% if not session.logged_in %}class="login-page"{% endif %}>
    {% if session.logged_in %}
    <div class="container main-content">
        <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
             <h1 class="page-title">Incus Web 管理器</h1>
             <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">退出登录</a>
        </div>

        {% if incus_error[0] %}
        <div class="alert alert-danger" role="alert">
            <strong>错误:</strong> 无法连接到 Incus 或执行命令失败。显示的数据可能来自数据库缓存。<br>详细信息: {{ incus_error[1] }}
        </div>
        {% endif %}

        <div class="row g-lg-4">
            <div class="col-lg-7 order-lg-1 left-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">容器列表</h2>
                    <div>
                        <button class="btn btn-sm btn-outline-primary d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCreateContainer" aria-controls="offcanvasCreateContainer">创建容器</button>
                        <button class="btn btn-sm btn-secondary" onclick="location.reload()">刷新列表</button>
                    </div>
                </div>

                <div class="container-list-desktop d-none d-lg-block">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="col-name">名称</th>
                                <th class="col-status">状态</th>
                                <th class="col-ip">IP 地址</th>
                                <th class="col-image">镜像来源</th>
                                <th class="col-created">创建时间</th>
                                <th class="col-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="containerListDesktop">
                        </tbody>
                    </table>
                </div>
                
                <div class="container-list-mobile d-block d-lg-none mt-3">
                </div>
            </div>

            <div class="col-lg-5 order-lg-2 d-none d-lg-block right-column">
                <div class="sticky-top-form-container">
                    <h2 class="section-title">创建新容器</h2>
                    <div class="create-form-panel">
                        <form id="createContainerForm">
                            <div class="row g-3">
                                <div class="col-12"><label for="containerName" class="form-label">容器名称</label><input type="text" class="form-control" id="containerName" name="name" required></div>
                                <div class="col-12">
                                    <label for="containerImage" class="form-label">选择镜像</label>
                                    <select class="form-select" id="containerImage" name="image" required>
                                        <option value="" selected disabled>请选择镜像</option>
                                        {% for image in images %}<option value="{{ image.name }}">{{ image.description }}</option>{% endfor %}
                                    </select>
                                    {% if image_error[0] %}<div class="form-text text-danger small mt-1">{{ image_error[1] }}</div>{% endif %}
                                </div>
                                <div class="col-12"><button type="submit" class="btn btn-primary w-100" id="createButton">创建容器</button></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCreateContainer" aria-labelledby="offcanvasCreateContainerLabel">
        <div class="offcanvas-header"><h5 class="offcanvas-title" id="offcanvasCreateContainerLabel">创建新容器</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button></div>
        <div class="offcanvas-body">
            <form id="createContainerFormMobile">
                 <div class="row g-3">
                    <div class="col-12"><label for="containerNameMobile" class="form-label">容器名称</label><input type="text" class="form-control" id="containerNameMobile" name="name" required></div>
                    <div class="col-12">
                        <label for="containerImageMobile" class="form-label">选择镜像</label>
                        <select class="form-select" id="containerImageMobile" name="image" required>
                            <option value="" selected disabled>请选择镜像</option>
                            {% for image in images %}<option value="{{ image.name }}">{{ image.description }}</option>{% endfor %}
                        </select>
                        {% if image_error[0] %}<div class="form-text text-danger small mt-1">{{ image_error[1] }}</div>{% endif %}
                    </div>
                    <div class="col-12"><button type="submit" class="btn btn-primary w-100" id="createButtonMobile">创建容器</button></div>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="container">
        <div id="loginFormContainer" class="py-5">
             <h2 class="form-title">管理员登录</h2>
             <form method="POST" action="{{ url_for('login') }}">
                 <input type="hidden" name="next" value="{{ request.args.get('next', '') }}">
                 <div class="mb-3"><label for="username" class="form-label">用户名</label><input type="text" class="form-control" id="username" name="username" required autofocus></div>
                 <div class="mb-3"><label for="password" class="form-label">密码</label><input type="password" class="form-control" id="password" name="password" required></div>
                 {% if login_error %}<div class="alert alert-danger mt-3">{{ login_error }}</div>{% endif %}
                 <button type="submit" class="btn btn-primary w-100 mt-4">登录</button>
             </form>
        </div>
    </div>
    {% endif %}

    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>
    <div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="infoModalLabel">容器信息</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="basicInfoContent"></div><div id="natRulesList" style="display:none;"><h6>NAT规则</h6><ul id="natRulesContent"></ul><div id="natRulesError" class="alert alert-warning d-none"></div></div><div id="infoError" class="alert alert-danger d-none"></div></div></div></div></div>
    <div class="modal fade" id="execModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="execModalLabel">执行命令</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="execCommandForm"><input type="hidden" id="execContainerName"><div class="mb-3"><label for="commandInput" class="form-label">命令</label><input type="text" class="form-control" id="commandInput" required></div><button type="submit" class="btn btn-primary" id="execButton">执行</button></form><h6 class="mt-3 mb-2">输出:</h6><pre id="execOutput"></pre></div></div></div></div>
    <div class="modal fade" id="natModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="natModalLabel">添加NAT规则</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-warning">临时规则</div><form id="addNatForm"><input type="hidden" id="natContainerName"><div class="mb-3"><label for="natContainerIP" class="form-label">容器IP</label><input type="text" class="form-control" id="natContainerIP" readonly></div><div class="mb-3"><label for="hostPort" class="form-label">主机端口</label><input type="number" class="form-control" id="hostPort" required min="1" max="65535"></div><div class="mb-3"><label for="containerPort" class="form-label">容器端口</label><input type="number" class="form-control" id="containerPort" required min="1" max="65535"></div><div class="mb-3"><label for="protocol" class="form-label">协议</label><select class="form-select" id="protocol" required><option value="tcp">TCP</option><option value="udp">UDP</option></select></div><button type="submit" class="btn btn-primary" id="addNatButton">添加</button></form></div></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="confirmModalLabel">请确认</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="confirmModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary" id="confirmActionButton">确认</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let allContainers = [];

    function initializeContainerData(containersData) {
        allContainers = Array.isArray(containersData) ? containersData : [];
        renderAllContainers();
    }

    function renderAllContainers() {
        renderContainerListDesktop(allContainers);
        renderContainerListMobile(allContainers);
    }

    function buildActionDropdown(c, index, isMobile = false) {
        const dropdownId = `actionsDropdown${isMobile ? 'Mobile' : 'Desktop'}${index}`;
        let actionsHtml = `<div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="${dropdownId}" data-bs-toggle="dropdown" aria-expanded="false">操作</button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="${dropdownId}">
                <li><button class="dropdown-item" type="button" onclick="showInfo('${c.name}', this)">信息</button></li>`;
        if (c.status === 'Running') {
            actionsHtml += `<li><button class="dropdown-item" onclick="performAction('${c.name}', 'stop', this)">停止</button></li>
                            <li><button class="dropdown-item" onclick="performAction('${c.name}', 'restart', this)">重启</button></li>
                            <li><button class="dropdown-item" onclick="openExecModal('${c.name}')">执行命令</button></li>
                            <li><button class="dropdown-item" onclick="openNatModal('${c.name}')">添加NAT</button></li>`;
        } else if (c.status === 'Stopped') {
            actionsHtml += `<li><button class="dropdown-item" onclick="performAction('${c.name}', 'start', this)">启动</button></li>`;
        }
        actionsHtml += `<li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item text-danger" onclick="performAction('${c.name}', 'delete', this)">删除</button></li>
            </ul></div>`;
        return actionsHtml;
    }

    function renderContainerListDesktop(containers) {
        const tbody = $('#containerListDesktop').empty();
        if (!containers.length) { 
            tbody.html('<tr><td colspan="6" class="text-center py-4">没有找到容器。</td></tr>'); 
            return; 
        }
        containers.forEach((c, i) => {
            const statusBadge = c.status === 'Running' ? 'success' : c.status === 'Stopped' ? 'danger' : 'secondary';
            const createdDate = c.created_at ? c.created_at.split('T')[0] : 'N/A';
            const containerName = c.name || '';
            const containerIp = c.ip || '-';
            const containerImage = c.image_source || 'N/A';

            tbody.append(`<tr>
                <td class="col-name" title="${containerName}">${containerName}</td>
                <td class="col-status"><span class="badge bg-${statusBadge}">${c.status}</span></td>
                <td class="col-ip" title="${containerIp}">${containerIp}</td>
                <td class="col-image" title="${containerImage}">${containerImage}</td>
                <td class="col-created" title="${createdDate}">${createdDate}</td>
                <td class="col-actions">${buildActionDropdown(c, i)}</td>
            </tr>`);
        });
    }

    function renderContainerListMobile(containers) {
        const mobileList = $('.container-list-mobile').empty();
        if (!containers.length) { 
            mobileList.html('<div class="alert alert-info text-center">没有找到容器。</div>'); 
            return; 
        }
        containers.forEach((c, i) => {
            const statusBadge = c.status === 'Running' ? 'success' : c.status === 'Stopped' ? 'danger' : 'secondary';
            mobileList.append(`<div class="card mb-3">
                <div class="card-body pb-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title mb-0">${c.name}</h5><span class="badge bg-${statusBadge}">${c.status}</span>
                    </div>
                    <p class="card-text mb-1"><small>IP:</small> ${c.ip || '-'}</p>
                    <p class="card-text mb-1"><small>镜像:</small> ${c.image_source || 'N/A'}</p>
                    <p class="card-text mb-2"><small>创建时间:</small> ${c.created_at ? c.created_at.split('T')[0] : 'N/A'}</p>
                </div>
                <div class="card-footer card-actions-dropdown">${buildActionDropdown(c, i, true)}</div>
            </div>`);
        });
    }

    $(document).ready(function() {
        initializeContainerData({{ containers|tojson|safe if session.logged_in else [] }});
        $('#confirmModal').on('hidden.bs.modal', function(){ currentConfirmAction=null; currentConfirmContainerName=null; currentConfirmRuleId=null; currentConfirmButtonElement=null;});
        $('#infoModal').on('hidden.bs.modal', function(){ $('#basicInfoContent').html('加载中...'); $('#natRulesContent').html('<li>加载中...</li>'); $('#natRulesError,#infoError').addClass('d-none').text(''); $('#infoModalLabel').text('容器信息'); $('#natRulesList').hide(); });
        $('#execModal').on('hidden.bs.modal', function(){ $('#execContainerName,#commandInput').val(''); $('#execOutput').text('').removeClass('success error'); $('#execModalLabel').text('执行命令'); setButtonProcessing($('#execButton'),false); });
        $('#natModal').on('hidden.bs.modal', function(){ $('#natContainerName,#natContainerIP,#hostPort,#containerPort').val(''); $('#protocol').val('tcp'); $('#natModalLabel').text('添加NAT规则'); setButtonProcessing($('#addNatButton'),false).prop('disabled',false).text('添加');});
    });
    function showToast(m,t='info'){let type=t==='success'?'success':t==='error'?'danger':t==='warning'?'warning':'info';$('#toastContainer').append(`<div class="toast align-items-center text-bg-${type} border-0" role="alert"><div class="d-flex"><div class="toast-body">${m}</div><button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`).children(':last').toast('show').on('hidden.bs.toast',function(){$(this).remove();});}
    function setButtonProcessing(b,s){const $b=$(b);if(!$b.length)return;if(s){if(!$b.data('h')){$b.data('h',$b.html());$b.html(`<span class="spinner-border spinner-border-sm me-1"></span> ${$b.text().trim()||'处理...'}`);$b.prop('disabled',true).addClass('btn-p');}}else{if($b.data('h'))$b.html($b.data('h')).removeData('h');$b.prop('disabled',false).removeClass('btn-p');}}
    var currentConfirmAction=null,currentConfirmContainerName=null,currentConfirmRuleId=null,currentConfirmButtonElement=null;
    function showConfirmationModal(a,id,b){currentConfirmAction=a;currentConfirmButtonElement=b;let ti='请确认',bd='',bc='btn-primary',bt='确认';if(a.endsWith('_container'))currentConfirmContainerName=id;else currentConfirmRuleId=id;if(a==='restart_container'){ti='确认重启';bd=`确定重启<strong>${id}</strong>？`;bc='btn-warning';bt='重启';}else if(a==='delete_container'){ti='确认删除';bd=`<strong>警告:</strong>永久删除<strong>${id}</strong>！<br>确定吗？`;bc='btn-danger';bt='删除';}else if(a==='delete_nat_rule'){ti='确认删除NAT';bd=`确定删除ID<strong>${id}</strong>的NAT规则？`;bc='btn-danger';bt='删除规则';}$('#confirmModalLabel').text(ti);$('#confirmModalBody').html(bd);$('#confirmActionButton').removeClass('btn-primary btn-warning btn-danger').addClass(bc).text(bt);setButtonProcessing($('#confirmActionButton'),!1);new bootstrap.Modal(document.getElementById('confirmModal')).show();}
    $('#confirmActionButton').click(function(){const a=currentConfirmAction,be=currentConfirmButtonElement,cb=$(this);if(!a||(!currentConfirmContainerName&&!currentConfirmRuleId)){showToast("信息丢失",'danger');bootstrap.Modal.getInstance(document.getElementById('confirmModal'))?.hide();return;}setButtonProcessing(cb,1);if(a!=='delete_nat_rule'&&be)setButtonProcessing(be,1);let u,y,d;if(a==='delete_nat_rule'){u=`/container/nat_rule/${currentConfirmRuleId}`;y='DELETE';}else{let o=a.replace('_container','');u=`/container/${currentConfirmContainerName}/action`;y='POST';d={action:o};}$.ajax({url:u,type:y,data:d,headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(res){showToast(res.message,res.status);if(res.status==='success'||(res.status==='warning'&&a==='delete_nat_rule')){if(a==='delete_nat_rule'){const cnm=$('#infoModalLabel').text().replace('容器信息: ','');if(cnm)loadNatRules(cnm);else location.reload();}else location.reload();}else if(be&&a!=='delete_nat_rule')setButtonProcessing(be,!1);},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{showToast(`失败: ${xhr.responseJSON?.message||'未知'}`,'danger');}if(be&&a!=='delete_nat_rule')setButtonProcessing(be,!1);},complete:function(){bootstrap.Modal.getInstance(document.getElementById('confirmModal'))?.hide();setButtonProcessing(cb,!1);}});});
    function handleCreateContainer(f,b){const $f=$(f),$b=$(b);setButtonProcessing($b,1);$.ajax({url:"{{url_for('create_container')}}",type:"POST",data:$f.serialize(),headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(res){showToast(res.message,res.status);if(res.status==='success'){$f[0].reset();const offcanvasEl = document.getElementById('offcanvasCreateContainer'); if(offcanvasEl) { const offcanvasBs = bootstrap.Offcanvas.getInstance(offcanvasEl); if(offcanvasBs) { offcanvasBs.hide();}} location.reload();}},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{showToast(`错误: ${xhr.responseJSON?.message||'创建失败'}`,'danger');}},complete:function(){setButtonProcessing($b,!1);}});}$('#createContainerForm').submit(function(e){e.preventDefault();handleCreateContainer(this,$('#createButton'));});$('#createContainerFormMobile').submit(function(e){e.preventDefault();handleCreateContainer(this,$('#createButtonMobile'));});
    function performAction(cn,a,b){if(a==='restart'||a==='delete'){showConfirmationModal(`${a}_container`,cn,b);return;}setButtonProcessing(b,1);$.ajax({url:`/container/${cn}/action`,type:"POST",data:{action:a},headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(res){showToast(res.message,res.status);if(res.status==='success')location.reload();else setButtonProcessing(b,!1);},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{showToast(`失败: ${xhr.responseJSON?.message||'未知'}`,'danger');}setButtonProcessing(b,!1);}});}
    function showInfo(cn,b){const m=new bootstrap.Modal(document.getElementById('infoModal'));$('#infoModalLabel').text(`容器信息: ${cn}`);$('#basicInfoContent').html('<p>加载中...</p>');$('#natRulesContent').html('<li>加载中...</li>');$('#natRulesError,#infoError').addClass('d-none');$('#natRulesList').show();if(b)setButtonProcessing(b,1);$.ajax({url:`/container/${cn}/info`,type:"GET",headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(d){if(d.status==='NotFound'){$('#basicInfoContent').html(`<p><strong>错误:</strong> ${d.message}</p>`);$('#infoError').removeClass('d-none').text(d.message);showToast("加载失败",'danger');$('#natRulesList').hide();return;}let h=`<p><strong>名称:</strong> ${d.name}</p><p><strong>状态:</strong> <span class="badge bg-${d.status==='Running'?'success':d.status==='Stopped'?'danger':'secondary'}">${d.status}</span> (${d.status_code})</p><p><strong>IP:</strong> ${d.ip||'-'}</p><p><strong>镜像:</strong> ${d.description||d.image_source||'N/A'}</p><p><strong>创建:</strong> ${d.created_at?d.created_at.split('T')[0]:'N/A'}</p><p><strong>架构:</strong> ${d.architecture||'N/A'}</p><p><strong>类型:</strong> ${d.type}</p><p><strong>临时:</strong> ${d.ephemeral?'是':'否'}</p><p><strong>配置:</strong> ${d.profiles.join(', ')||'无'}</p><p class="mt-2"><small class="text-muted">${d.message||''}</small></p>`;$('#basicInfoContent').html(h);if(!d.live_data_available&&d.status!=='NotFound')showToast(d.message,'warning');loadNatRules(cn);},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{$('#basicInfoContent').html(`<p><strong>错误:</strong> ${xhr.responseJSON?.message||"请求失败"}</p>`);$('#infoError').removeClass('d-none').text(xhr.responseJSON?.message||"请求失败");$('#natRulesList').hide();showToast("加载失败",'danger');}},complete:function(){if(b)setButtonProcessing(b,!1);m.show();}});}
    function loadNatRules(cn){$.ajax({url:`/container/${cn}/nat_rules`,type:"GET",headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(d){$('#natRulesContent').empty();if(d.status==='success'&&d.rules?.length>0){d.rules.forEach(r=>{$('#natRulesContent').append(`<li data-rule-id="${r.id}"><span class="rule-details"><strong>ID ${r.id}:</strong> 主机 ${r.host_port}/${r.protocol} → 容器 ${r.ip_at_creation}:${r.container_port}<br><small>创建: ${r.created_at?new Date(r.created_at).toLocaleString():'N/A'}</small></span><span class="rule-actions"><button class="btn btn-sm btn-danger" onclick="deleteNatRule(${r.id},this)">删除</button></span></li>`);});}else if(d.status==='success')$('#natRulesContent').html('<li>无NAT记录。</li>');else{$('#natRulesContent').html('<li>加载NAT失败。</li>');$('#natRulesError').removeClass('d-none').text(d.message||'错误');showToast(d.message||"加载NAT失败",'danger');}},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{$('#natRulesContent').html('<li>加载NAT失败。</li>');$('#natRulesError').removeClass('d-none').text(xhr.responseJSON?.message||"请求失败");showToast(xhr.responseJSON?.message||"加载NAT失败",'danger');}}});}
    function deleteNatRule(id,b){showConfirmationModal('delete_nat_rule',id,b);}
    function openExecModal(cn){$('#execContainerName').val(cn);$('#execModalLabel').text(`在${cn}执行`);$('#commandInput').val('');$('#execOutput').text('').removeClass('success error');setButtonProcessing($('#execButton'),!1);new bootstrap.Modal(document.getElementById('execModal')).show();}
    $('#execCommandForm').submit(function(e){e.preventDefault();const $f=$(this), $b=$('#execButton',$f),$o=$('#execOutput');let cn=$('#execContainerName').val(),cd=$('#commandInput').val();if(!cd.trim()){showToast("输入命令",'warning');return;}$o.text('执行中...').removeClass('success error');setButtonProcessing($b,1);$.ajax({url:`/container/${cn}/exec`,type:"POST",data:{command:cd},headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(d){if(d.status==='success'){$o.text(d.output).addClass('success');showToast("成功",'success');}else{$o.text(`失败:\n${d.output||d.message||'无输出'}`).addClass('error');showToast(d.message||"失败",'danger');}},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{const m=xhr.responseJSON?.output||xhr.responseJSON?.message||'未知';$o.text(`请求失败:\n${m}`).addClass('error');showToast("请求失败",'danger');}},complete:function(){setButtonProcessing($b,!1);}});});
    function openNatModal(cn){$('#natContainerName').val(cn);$('#natModalLabel').text(`为${cn}添加NAT`);$('#hostPort,#containerPort').val('');$('#protocol').val('tcp');$('#natContainerIP').val('获取IP...');setButtonProcessing($('#addNatButton'),!1).prop('disabled',!1).text('添加');new bootstrap.Modal(document.getElementById('natModal')).show();$.ajax({url:`/container/${cn}/info`,type:"GET",headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(d){if(d.status==='NotFound'||d.status!=='Running'||!d.ip||d.ip==='N/A'){const e=d.status!=='Running'?'未运行':(d.ip==='N/A'?'无IP':(d.message||"无法获取IP"));$('#natContainerIP').val(`失败:${e}`);$('#addNatButton').prop('disabled',1).text('无法添加');showToast(`无法添加NAT:${e}`,'warning');}else{$('#natContainerIP').val(d.ip);}},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');const natModalEl = document.getElementById('natModal'); if(natModalEl) { const natModalBs = bootstrap.Modal.getInstance(natModalEl); if(natModalBs) { natModalBs.hide();}} setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{$('#natContainerIP').val('获取IP失败');$('#addNatButton').prop('disabled',1).text('无法添加');showToast(xhr.responseJSON?.message||"获取IP失败",'danger');}}});}
    $('#addNatForm').submit(function(e){e.preventDefault();const $f=$(this),$b=$('#addNatButton',$f);setButtonProcessing($b,1);$.ajax({url:`/container/${$('#natContainerName').val()}/add_nat_rule`,type:"POST",data:$f.serialize(),headers:{'X-API-Hash':'{{API_SECRET_HASH}}'},success:function(d){showToast(d.message,d.status);if(d.status==='success'||d.status==='warning'){const cnm=$('#infoModalLabel').text().replace('容器信息: ','');if(cnm===$('#natContainerName').val())loadNatRules(cnm);if(d.status==='success'){$f.find('#hostPort,#containerPort').val('');$f.find('#protocol').val('tcp');}}},error:function(xhr){if(xhr.status===401){showToast("需认证",'danger');const natModalEl = document.getElementById('natModal'); if(natModalEl) { const natModalBs = bootstrap.Modal.getInstance(natModalEl); if(natModalBs) { natModalBs.hide();}} setTimeout(()=>window.location.href="{{url_for('login',next=request.url)}}",1E3);}else{showToast(xhr.responseJSON?.message||'添加失败','danger');}},complete:function(){setButtonProcessing($b,!1);}});});
</script>
</body>
</html>
